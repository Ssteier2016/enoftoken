<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- MEJORADO: A√±adido maximum-scale y user-scalable para zoom en m√≥vil -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Gesti√≥n de Negocios - Pro v3.9.13</title>
    <!-- ASEG√öRATE QUE EL MANIFEST.JSON EST√â EN LA MISMA CARPETA -->
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            font-family: 'Inter', system-ui, sans-serif;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            
            /* Colores Modo Claro */
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --card-bg: #ffffff;
            --input-bg: #f9fafb;
            --modal-bg: #ffffff;
        }
        
        [data-theme="dark"] {
            /* Colores Modo Oscuro */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --card-bg: #1e293b;
            --input-bg: #334155;
            --modal-bg: #1e293b;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            /* MEJORADO: Permitir scroll t√°ctil en toda la p√°gina */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Splash Screen con gradiente animado */
        #splashScreen { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
            transition: opacity .6s ease-out; 
            opacity: 1; 
            pointer-events: all;
        }
        
        [data-theme="dark"] #splashScreen {
            background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%);
        }
        
        #splashScreen .text-blue-600 {
            color: white !important;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        
        #splashScreen h1 { color: white; }
        #splashScreen p { color: rgba(255,255,255,0.8); }
        
        #mainContent { 
            opacity: 0; 
            transition: opacity .8s ease-in; 
            pointer-events: none; 
        }
        #mainContent.visible { 
            opacity: 1; 
            pointer-events: auto; 
        }
        
        /* Tarjetas adaptadas al tema */
        .bg-white {
            background-color: var(--card-bg) !important;
            transition: all 0.3s ease;
        }
        
        [data-theme="dark"] .text-gray-800,
        [data-theme="dark"] .text-gray-900 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .text-gray-500,
        [data-theme="dark"] .text-gray-400 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .text-gray-700 {
            color: #cbd5e1 !important;
        }
        
        [data-theme="dark"] .bg-gray-50 {
            background-color: var(--bg-secondary) !important;
        }

        [data-theme="dark"] .border-gray-100,
        [data-theme="dark"] .border-gray-200 {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .bg-gray-50 {
            background-color: var(--bg-tertiary) !important;
        }
        
        [data-theme="dark"] .bg-gray-100 {
            background-color: #334155 !important;
        }
        
        /* Tarjetas con efecto glassmorphism */
        .card-border-l { 
            border-left-width: 5px;
            transition: all 0.3s ease;
        }
        
        .card-border-l:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -8px rgba(0,0,0,0.15);
        }
        
        [data-theme="dark"] .card-border-l:hover {
            box-shadow: 0 12px 24px -8px rgba(0,0,0,0.5);
        }
        
        /* Modal overlay mejorado */
        .modal-overlay { 
            background: rgba(0,0,0,.6); 
            backdrop-filter: blur(8px);
            animation: fadeIn 0.2s ease-out;
            /* MEJORADO: Permitir scroll t√°ctil en modales */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        [data-theme="dark"] .modal-overlay {
            background: rgba(0,0,0,.8);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Tablas con hover suave */
        .table-header { 
            @apply px-6 py-3 text-left text-xs font-medium uppercase tracking-wider;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table-cell { 
            @apply px-6 py-4 whitespace-nowrap text-sm;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.15s ease;
        }
        
        tbody tr:hover .table-cell {
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        [data-theme="dark"] tbody tr:hover .table-cell {
            background-color: rgba(59, 130, 246, 0.15);
        }
        
        /* Input mejorado con efectos */
        .input-std { 
            @apply block w-full rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2.5 border;
            background-color: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
            transition: all 0.2s ease;
        }
        
        .input-std:focus {
            background-color: var(--card-bg);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }
        
        [data-theme="dark"] .input-std::placeholder {
            color: #64748b;
        }
        
        /* Campos protegidos con mejor estilo */
        .protected-field { 
            font-family: monospace; 
            letter-spacing: 2px;
            background: linear-gradient(135deg, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.02) 100%);
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        [data-theme="dark"] .protected-field {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
        }
        
        .protected-field.revealed { 
            font-family: 'Inter', system-ui, sans-serif; 
            letter-spacing: normal;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%);
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }
        
        /* Men√∫ lateral con sombra elegante */
        #sideMenu { 
            transform: translateX(-100%); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 4px 0 24px rgba(0,0,0,0.15);
            background-color: var(--card-bg);
        }
        
        [data-theme="dark"] #sideMenu {
            box-shadow: 4px 0 24px rgba(0,0,0,0.6);
        }
        
        #sideMenu.open { 
            transform: translateX(0); 
        }
        
        /* Botones con efectos hover mejorados */
        button {
            transition: all 0.2s ease;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        /* Botones principales con gradientes */
        .bg-blue-600 {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .bg-blue-600:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }
        
        /* Cards del dashboard con efectos */
        .group:hover .bg-orange-100,
        .group:hover .bg-blue-100,
        .group:hover .bg-green-100,
        .group:hover .bg-red-100,
        .group:hover .bg-indigo-100 {
            transform: scale(1.1) rotate(5deg);
        }
        
        /* Animaci√≥n para iconos */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Scrollbar personalizado - MEJORADO PARA ARQUEO DE CAJA */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
            transition: background 0.2s;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
            border: 2px solid transparent;
            background-clip: content-box;
        }
        
        /* Efecto para modales al aparecer */
        .modal-overlay > div {
            animation: slideUp 0.3s ease-out;
            background-color: var(--modal-bg);
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Bot√≥n de toggle theme */
        #themeToggle {
            position: relative;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 50%;
        }
        
        #themeToggle:hover {
            transform: rotate(15deg);
            background-color: var(--bg-tertiary);
        }
        
        /* Badge para notificaciones */
        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 8px;
            background-color: #ef4444;
            border-radius: 50%;
            display: none;
        }
        .notification-badge.active {
            display: block;
        }

        /* Adaptaciones espec√≠ficas para modo oscuro */
        [data-theme="dark"] nav {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        
        [data-theme="dark"] .shadow-sm,
        [data-theme="dark"] .shadow-md,
        [data-theme="dark"] .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
        }

        /* TOAST NOTIFICATION STYLES */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column-reverse; /* Las nuevas notificaciones aparecen abajo */
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            color: white;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: #10b981; } /* Green */
        .toast.error { background-color: #ef4444; }  /* Red */
        .toast.info { background-color: #3b82f6; }   /* Blue */
        
        /* Estilo para scrollbar de arqueo de caja - MEJORADO */
        .touch-scroll {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--bg-tertiary);
        }
        
        /* Estilo para bot√≥n de notificaciones push */
        .notification-toggle {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .notification-toggle.active {
            color: #3b82f6 !important;
        }
        
        .notification-toggle.active i {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Mejoras para m√≥vil en tabla de movimientos de caja */
        @media (max-width: 768px) {
            .mobile-cash-table td {
                padding: 8px 4px !important;
                font-size: 12px !important;
            }
            .mobile-cash-table th {
                padding: 8px 4px !important;
                font-size: 11px !important;
            }
            .mobile-cash-table .table-cell {
                padding-left: 8px !important;
                padding-right: 8px !important;
            }
        }
        
        /* Estilos para la tabla de venta masiva */
        .massive-sale-row {
            transition: all 0.2s ease;
        }
        
        .massive-sale-row:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        [data-theme="dark"] .massive-sale-row:hover {
            background-color: rgba(59, 130, 246, 0.15);
        }
        
        .massive-sale-table th {
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            z-index: 10;
        }
        
        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .sortable-header:hover {
            background-color: var(--bg-tertiary);
        }
        
        .sort-arrow {
            font-size: 10px;
            margin-left: 4px;
            opacity: 0.6;
        }
        
        /* Estilos para el switch de tipo de venta */
        .sale-type-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            background-color: var(--bg-tertiary);
            border-radius: 9999px;
            padding: 2px;
            margin-bottom: 16px;
        }
        
        .sale-type-option {
            padding: 8px 16px;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            z-index: 1;
            position: relative;
        }
        
        .sale-type-option.active {
            background-color: var(--card-bg);
            box-shadow: var(--shadow-sm);
            color: var(--text-primary);
        }
        
        .sale-type-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            height: calc(100% - 4px);
            border-radius: 9999px;
            background-color: var(--card-bg);
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s ease;
            width: calc(50% - 4px);
        }
        
        .massive-sale-input {
            @apply block w-full rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm;
            background-color: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
            transition: all 0.2s ease;
        }
        
        .massive-sale-input:focus {
            background-color: var(--card-bg);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }
        
        .add-row-btn {
            background-color: var(--bg-tertiary);
            border: 2px dashed var(--border-color);
            color: var(--text-secondary);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .add-row-btn:hover {
            background-color: var(--card-bg);
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }
        
        .delete-row-btn {
            color: #ef4444;
            opacity: 0.6;
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .delete-row-btn:hover {
            opacity: 1;
            background-color: rgba(239, 68, 68, 0.1);
        }

        /* Estilos para PIN */
        .pin-input {
            font-family: monospace;
            font-size: 24px;
            letter-spacing: 10px;
            text-align: center;
            padding: 12px;
        }
        
        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            display: inline-block;
            margin: 0 8px;
            transition: background-color 0.2s ease;
        }
        
        .pin-dot.active {
            background-color: #3b82f6;
        }
        
        /* Estilos para secciones protegidas */
        .protected-section {
            position: relative;
        }
        
        .protected-section:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            border-radius: inherit;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .protected-section.locked:after {
            opacity: 1;
        }
        
        .protected-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        [data-theme="dark"] .protected-overlay {
            background: rgba(30, 41, 59, 0.9);
        }
        
        /* Estilo para valores ocultos con asteriscos */
        .hidden-value {
            font-family: monospace;
            letter-spacing: 4px;
            color: var(--text-secondary);
            filter: blur(2px);
            transition: all 0.3s ease;
        }
        
        .hidden-value.revealed {
            filter: none;
            color: var(--text-primary);
            letter-spacing: normal;
            font-family: 'Inter', system-ui, sans-serif;
        }
        
        /* Estilos para el modal de detalles diarios */
        .daily-detail-row {
            border-bottom: 1px solid var(--border-color);
            padding: 12px 0;
            transition: background-color 0.2s ease;
        }
        
        .daily-detail-row:hover {
            background-color: var(--bg-tertiary);
        }
        
        .payment-method-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin: 2px;
        }
        
        .payment-method-efectivo { background-color: #dcfce7; color: #166534; }
        .payment-method-tarjeta { background-color: #dbeafe; color: #1e40af; }
        .payment-method-transferencia { background-color: #f3e8ff; color: #6b21a8; }
        .payment-method-qr { background-color: #fef3c7; color: #92400e; }
        .payment-method-nave { background-color: #ffe4e6; color: #9f1239; }
        .payment-method-otro { background-color: #e5e7eb; color: #374151; }

        /* ESTILOS PARA EL NIVEL 1 - MODO JOYSTICK */
        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 400px;
            margin: 0 auto;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Joystick Virtual */
        #virtualJoystick {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            border: 2px solid rgba(59, 130, 246, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            touch-action: none;
            user-select: none;
        }

        #joystickHandle {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 50%;
            cursor: move;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            transition: transform 0.1s;
        }

        #joystickHandle.active {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.6);
        }

        /* Indicadores de direcci√≥n */
        .direction-indicator {
            position: absolute;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.3);
            font-size: 18px;
        }

        #upIndicator { top: 5px; left: 50%; transform: translateX(-50%); }
        #downIndicator { bottom: 5px; left: 50%; transform: translateX(-50%); }
        #leftIndicator { left: 5px; top: 50%; transform: translateY(-50%); }
        #rightIndicator { right: 5px; top: 50%; transform: translateY(-50%); }

        /* Controles de acci√≥n */
        #actionButtons {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        .action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.8);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(239, 68, 68, 0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .action-btn:active {
            transform: scale(0.95);
            background: rgba(239, 68, 68, 1);
        }

        #jumpBtn {
            background: rgba(34, 197, 94, 0.8);
            border-color: rgba(34, 197, 94, 0.3);
        }

        #jumpBtn:active {
            background: rgba(34, 197, 94, 1);
        }

        /* Informaci√≥n del juego */
        #gameInfo {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 100;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .game-stat {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Modal de nivel 1 */
        #level1Modal .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            border: 2px solid rgba(59, 130, 246, 0.3);
        }

        /* Jugador centrado */
        .player {
            position: absolute;
            transition: transform 0.1s linear;
            will-change: transform;
        }

        /* Obst√°culos */
        .obstacle {
            position: absolute;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-radius: 8px;
        }

        /* Monedas */
        .coin {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle at 30% 30%, #fbbf24, #f59e0b);
            border-radius: 50%;
            animation: coin-spin 2s linear infinite;
        }

        @keyframes coin-spin {
            0% { transform: rotateY(0); }
            100% { transform: rotateY(360deg); }
        }

        /* Particulas de efecto */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden">
    <!-- CONTENEDOR DE TOASTS -->
    <div id="toastContainer"></div>

    <!-- BANNER DE ACTUALIZACI√ìN DE PWA (SOLICITADO POR EL USUARIO) -->
    <div id="updateNotification" class="hidden fixed bottom-0 left-0 right-0 p-3 bg-yellow-500 text-white z-[90] text-center shadow-lg flex justify-center items-center gap-4">
        <div class="flex items-center gap-2 font-bold"><i class="fas fa-sync-alt animate-spin"></i> Nueva versi√≥n disponible.</div>
        <button id="reloadUpdateBtn" class="bg-yellow-700 hover:bg-yellow-800 text-white font-bold py-1 px-3 rounded-full transition text-sm">Recargar y Actualizar</button>
    </div>

    <div id="splashScreen">
        <div class="text-center">
            <div class="text-6xl text-blue-600 mb-4 animate-bounce"><i class="fas fa-chart-pie"></i></div>
            <h1 class="text-xl font-bold text-gray-700">Cargando Sistema...</h1>
            <p class="text-sm text-gray-400 mt-2">v3.9.13 - Pro</p>
        </div>
    </div>

    <!-- MODAL NIVEL 1 - MODO JOYSTICK -->
    <div id="level1Modal" class="modal-overlay fixed inset-0 z-[200] hidden flex items-center justify-center p-4">
        <div class="rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="p-6 bg-gradient-to-r from-blue-600 to-purple-600 text-white flex justify-between items-center">
                <h2 class="text-2xl font-bold"><i class="fas fa-gamepad mr-2"></i> Nivel 1 - Modo Joystick üïπÔ∏è</h2>
                <button data-close="level1Modal" class="text-white opacity-80 hover:opacity-100 text-2xl"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-1 p-6 space-y-4 bg-gradient-to-b from-gray-900 to-gray-800">
                <!-- Informaci√≥n del juego -->
                <div id="gameInfo">
                    <div class="game-stat">
                        <i class="fas fa-coins mr-2 text-yellow-400"></i>
                        <span id="coinCount">0</span> Monedas
                    </div>
                    <div class="game-stat">
                        <i class="fas fa-heart mr-2 text-red-400"></i>
                        <span id="healthCount">100</span> HP
                    </div>
                    <div class="game-stat">
                        <i class="fas fa-tachometer-alt mr-2 text-green-400"></i>
                        <span id="scoreCount">0</span> Puntos
                    </div>
                </div>

                <!-- Canvas del juego -->
                <div id="gameContainer">
                    <canvas id="gameCanvas"></canvas>
                    
                    <!-- Joystick Virtual -->
                    <div id="virtualJoystick">
                        <div class="direction-indicator" id="upIndicator"><i class="fas fa-arrow-up"></i></div>
                        <div class="direction-indicator" id="downIndicator"><i class="fas fa-arrow-down"></i></div>
                        <div class="direction-indicator" id="leftIndicator"><i class="fas fa-arrow-left"></i></div>
                        <div class="direction-indicator" id="rightIndicator"><i class="fas fa-arrow-right"></i></div>
                        <div id="joystickHandle"></div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div id="actionButtons">
                        <button id="jumpBtn" class="action-btn">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button id="actionBtn" class="action-btn">
                            <i class="fas fa-bolt"></i>
                        </button>
                    </div>
                </div>

                <!-- Instrucciones -->
                <div class="bg-gray-800/50 backdrop-blur-sm p-4 rounded-xl border border-gray-700">
                    <h3 class="font-bold text-white mb-2"><i class="fas fa-info-circle mr-2 text-blue-400"></i>Instrucciones</h3>
                    <ul class="text-sm text-gray-300 space-y-1">
                        <li><i class="fas fa-gamepad mr-2 text-purple-400"></i> Usa el <strong>joystick virtual</strong> para mover al jugador</li>
                        <li><i class="fas fa-arrow-up mr-2 text-green-400"></i> <strong>Pulsa arriba</strong> en el joystick para saltar</li>
                        <li><i class="fas fa-bolt mr-2 text-yellow-400"></i> Presiona el <strong>bot√≥n de acci√≥n</strong> para habilidades especiales</li>
                        <li><i class="fas fa-coins mr-2 text-yellow-400"></i> Recolecta monedas para aumentar tu puntuaci√≥n</li>
                        <li><i class="fas fa-skull-crossbones mr-2 text-red-400"></i> Evita los obst√°culos rojos</li>
                    </ul>
                </div>
            </div>

            <div class="p-4 bg-gray-900 border-t border-gray-800 flex justify-between items-center">
                <button id="resetGameBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-redo mr-2"></i>Reiniciar
                </button>
                <button data-close="level1Modal" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-check mr-2"></i>Completar Nivel
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIGURACI√ìN DE PIN -->
    <div id="pinConfigModal" class="modal-overlay fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b flex justify-between items-center bg-purple-50 rounded-t-2xl">
                <h2 class="text-xl font-bold text-purple-700"><i class="fas fa-lock mr-2"></i> Configuraci√≥n de PIN</h2>
                <button data-close="pinConfigModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Configurar nuevo PIN -->
                <div class="space-y-3">
                    <h3 class="font-bold text-gray-700">Establecer nuevo PIN</h3>
                    <div class="flex justify-center gap-3 mb-4">
                        <div class="pin-dot" id="pinDot1"></div>
                        <div class="pin-dot" id="pinDot2"></div>
                        <div class="pin-dot" id="pinDot3"></div>
                        <div class="pin-dot" id="pinDot4"></div>
                    </div>
                    <input type="password" id="newPinInput" class="pin-input input-std" maxlength="4" placeholder="****" inputmode="numeric" pattern="[0-9]*">
                    <p class="text-xs text-gray-500">Ingresa 4 d√≠gitos para el nuevo PIN</p>
                    <button id="setPinBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold">Establecer PIN</button>
                </div>
                
                <!-- Configurar secciones protegidas -->
                <div class="space-y-3 pt-6 border-t">
                    <h3 class="font-bold text-gray-700">Secciones protegidas por PIN</h3>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="protectSalesHistory" class="rounded">
                            <span>Ver Ventas</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="protectProfit" class="rounded">
                            <span>Ver Rentabilidad</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="protectGrossProfit" class="rounded">
                            <span>Ganancia Bruta (Arqueo)</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="protectCashReal" class="rounded">
                            <span>Caja Real (Arqueo)</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="protectSalesMonth" class="rounded">
                            <span>Venta (Mes) - Tarjeta Principal</span>
                        </label>
                        <!-- NUEVO: Proteger Ganancia Neta -->
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="protectNetProfit" class="rounded">
                            <span>Ganancia Neta (Mes)</span>
                        </label>
                    </div>
                    <button id="savePinConfigBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold">Guardar Configuraci√≥n</button>
                </div>
                
                <!-- Eliminar PIN -->
                <div class="pt-6 border-t">
                    <button id="removePinBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg">Eliminar PIN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE VERIFICACI√ìN DE PIN -->
    <div id="pinVerifyModal" class="modal-overlay fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="p-6 border-b flex justify-between items-center bg-blue-50 rounded-t-2xl">
                <h2 class="text-xl font-bold text-blue-700">Verificaci√≥n de PIN</h2>
                <button data-close="pinVerifyModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 text-center space-y-4">
                <p id="pinVerifyMessage" class="text-gray-600">Ingresa tu PIN para acceder</p>
                <div class="flex justify-center gap-3 mb-4">
                    <div class="pin-dot" id="verifyPinDot1"></div>
                    <div class="pin-dot" id="verifyPinDot2"></div>
                    <div class="pin-dot" id="verifyPinDot3"></div>
                    <div class="pin-dot" id="verifyPinDot4"></div>
                </div>
                <input type="password" id="pinVerifyInput" class="pin-input input-std" maxlength="4" placeholder="****" inputmode="numeric" pattern="[0-9]*" autofocus>
                <p id="pinError" class="text-red-500 text-sm hidden">PIN incorrecto. Intenta de nuevo.</p>
                <button id="submitPinBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold">Verificar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DETALLES DIARIOS (NUEVO) -->
    <div id="dailyDetailsModal" class="modal-overlay fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-blue-50 rounded-t-2xl">
                <h2 class="text-xl font-bold text-blue-700">Detalles Diarios</h2>
                <div class="flex items-center gap-2">
                    <input type="date" id="dailyDetailsDate" class="input-std w-40">
                    <button onclick="loadDailyDetails()" class="bg-blue-600 text-white px-3 py-2 rounded-lg"><i class="fas fa-search"></i></button>
                </div>
                <button data-close="dailyDetailsModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- RESUMEN DEL D√çA -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <div class="text-xs text-blue-600 font-bold uppercase mb-1">Ventas Totales</div>
                        <div class="text-2xl font-bold text-blue-800" id="dailyTotalSales">$0.00</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                        <div class="text-xs text-green-600 font-bold uppercase mb-1">Gastos Totales</div>
                        <div class="text-2xl font-bold text-green-800" id="dailyTotalExpenses">$0.00</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <div class="text-xs text-purple-600 font-bold uppercase mb-1">Ganancia Neta</div>
                        <div class="text-2xl font-bold text-purple-800" id="dailyNetProfit">$0.00</div>
                    </div>
                </div>
                
                <!-- VENTAS POR M√âTODO DE PAGO -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">Ventas por M√©todo de Pago</h3>
                    <div id="dailySalesByPayment" class="space-y-2">
                        <!-- Aqu√≠ se cargar√°n las ventas por m√©todo de pago -->
                    </div>
                </div>
                
                <!-- DETALLE DE VENTAS -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">Detalle de Ventas</h3>
                    <div id="dailySalesDetail" class="space-y-3">
                        <!-- Aqu√≠ se cargar√°n los detalles de ventas -->
                    </div>
                </div>
                
                <!-- DETALLE DE GASTOS -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">Detalle de Gastos</h3>
                    <div id="dailyExpensesDetail" class="space-y-3">
                        <!-- Aqu√≠ se cargar√°n los detalles de gastos -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MEN√ö LATERAL -->
    <div id="sideMenuOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden"></div>
    <div id="sideMenu" class="fixed top-0 left-0 h-full w-80 shadow-2xl z-[70] flex flex-col">
        <div class="p-6 bg-blue-600 text-white flex justify-between items-center"><h2 class="text-xl font-bold"><i class="fas fa-store mr-2"></i> Mi Tienda</h2><button id="closeSideMenuBtn" class="text-white hover:text-gray-200"><i class="fas fa-times text-xl"></i></button></div>
        <div class="p-6 flex-1 overflow-y-auto">
            <!-- SECCI√ìN ACTUALIZADA DE GESTI√ìN DE PERSONAL -->
            <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">Gesti√≥n de Personal</h3>
            
            <!-- BOTONES DE ACCI√ìN PARA EL PERSONAL -->
            <div class="space-y-4 mb-6">
                <button id="btnOpenEmployeeStats" class="w-full bg-indigo-50 text-indigo-700 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center gap-2 hover:bg-indigo-100 transition"><i class="fas fa-users-cog"></i> Ver Sueldos y Horas</button>
                
                <!-- NUEVO BOT√ìN DE TUTORIALES -->
                <button id="btnOpenTutorialsModal" class="w-full bg-blue-50 text-blue-700 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center gap-2 hover:bg-blue-100 transition"><i class="fas fa-question-circle"></i> Tutoriales</button>
                
                <!-- NUEVO: BOT√ìN DE NIVEL 1 - MODO JOYSTICK -->
                <button id="btnOpenLevel1" class="w-full bg-green-50 text-green-700 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center gap-2 hover:bg-green-100 transition"><i class="fas fa-gamepad mr-2"></i> Nivel 1 - Modo Joystick</button>
                
                <!-- NUEVO: BOT√ìN DE CONFIGURACI√ìN DE PIN -->
                <button id="btnOpenPinConfig" class="w-full bg-purple-50 text-purple-700 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center gap-2 hover:bg-purple-100 transition"><i class="fas fa-lock"></i> Configurar PIN</button>
                
                <!-- NUEVO: BOT√ìN DE DETALLES DIARIOS -->
                <button id="btnOpenDailyDetails" class="w-full bg-green-50 text-green-700 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center gap-2 hover:bg-green-100 transition"><i class="fas fa-calendar-day"></i> Detalles Diarios</button>
            </div>
            
            <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Lista de Empleados</h4>
            <form id="addEmployeeForm" class="flex gap-2 mb-4"><input type="text" id="newEmployeeInput" class="input-std text-sm" placeholder="Agregar nombre..." required><button type="submit" class="bg-blue-600 text-white px-3 rounded-lg"><i class="fas fa-plus"></i></button></form>
            <div id="employeeListContainer" class="space-y-2"></div>
        </div>
        <div class="p-4 bg-gray-50 border-t text-center text-xs text-gray-400">Sistema v3.9.13 Pro</div>
    </div>

    <div id="mainContent">
        <nav class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <button id="openSideMenuBtn" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-bars"></i></button>
                    <div class="flex items-center gap-2 p-2 rounded-lg"><span id="storeNameDisplay" class="text-xl font-bold text-gray-800 tracking-tight">MI NEGOCIO</span></div>
                </div>
                <div class="flex gap-4 text-gray-500 items-center">
                    <button id="installAppBtn" class="hidden bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-bold hover:bg-blue-200 transition"><i class="fas fa-download mr-1"></i> Instalar App</button>
                    <!-- BOT√ìN CAMPANITA DE NOVEDADES -->
                    <button id="openNewsModalBtn" class="relative text-gray-500 hover:text-blue-600 text-xl transition transform hover:scale-110">
                        <i class="fas fa-bell"></i>
                        <span id="newsBadge" class="notification-badge"></span>
                    </button>
                    <!-- BOT√ìN TOGGLE NOTIFICACIONES PUSH -->
                    <button id="notificationToggleBtn" class="notification-toggle text-gray-500 hover:text-blue-600 text-xl transition transform hover:scale-110" title="Activar/Desactivar notificaciones">
                        <i class="fas fa-bell-slash"></i>
                    </button>
                    <button id="themeToggle" class="text-gray-500 hover:text-blue-600"><i class="fas fa-moon"></i></button>
                    <div id="connectionStatus" class="text-xs bg-gray-100 px-2 py-1 rounded-full text-gray-500 hidden md:block"><i class="fas fa-circle text-[8px] mr-1"></i> Iniciando...</div>
                    <button id="openProfileModalBtn" class="hover:text-blue-600 text-2xl transition transform hover:scale-110"><i class="fas fa-user-circle"></i></button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div><h1 class="text-2xl font-bold text-gray-900">Panel de Control</h1><p class="text-sm text-gray-500">Resumen de actividad en tiempo real</p></div>
                <div class="text-right bg-white px-4 py-2 rounded-xl shadow-sm border border-gray-100 flex flex-col items-end min-w-[150px]">
                    <div id="currentDateDisplay" class="text-sm font-bold text-blue-600 capitalize">Cargando fecha...</div>
                    <div id="currentTimeDisplay" class="text-xs text-gray-400">--:--:--</div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                <button id="openInventarioBtn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition text-center group border border-gray-100 cursor-pointer">
                    <div class="w-10 h-10 mx-auto bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mb-2 group-hover:scale-110 transition"><i class="fas fa-box"></i></div>
                    <div class="font-semibold text-sm text-gray-700">Inventario</div>
                    <div class="text-xs text-gray-400 mt-1">Total: <span id="dashTotalProductos">0</span></div>
                </button>
                <button id="openVentasHistoryBtn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition text-center group border border-gray-100 cursor-pointer protected-section" data-protected="salesHistory">
                    <div class="w-10 h-10 mx-auto bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-2 group-hover:scale-110 transition"><i class="fas fa-shopping-cart"></i></div>
                    <div class="font-semibold text-sm text-gray-700">Ver Ventas</div>
                    <div class="text-xs text-gray-400 mt-1">Hoy: <span id="dashVentasHoy">$0</span></div>
                </button>
                <button id="openGananciasHistoryBtn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition text-center group border border-gray-100 cursor-pointer protected-section" data-protected="profitHistory">
                    <div class="w-10 h-10 mx-auto bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-2 group-hover:scale-110 transition"><i class="fas fa-chart-line"></i></div>
                    <div class="font-semibold text-sm text-gray-700">Ver Ganancias</div>
                    <div class="text-xs text-gray-400 mt-1">Rentabilidad</div>
                </button>
                <button id="openGastosHistoryBtn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition text-center group border border-gray-100 cursor-pointer">
                    <div class="w-10 h-10 mx-auto bg-red-100 text-red-600 rounded-full flex items-center justify-center mb-2 group-hover:scale-110 transition"><i class="fas fa-receipt"></i></div>
                    <div class="font-semibold text-sm text-gray-700">Ver Gastos</div>
                    <div class="text-xs text-gray-400 mt-1">Hoy: <span id="dashGastosHoy">$0</span></div>
                </button>
                <button id="openClientesBtn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition text-center group border border-gray-100 cursor-pointer">
                    <div class="w-10 h-10 mx-auto bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mb-2 group-hover:scale-110 transition"><i class="fas fa-users"></i></div>
                    <div class="font-semibold text-sm text-gray-700">Clientes</div>
                    <div class="text-xs text-gray-400 mt-1"><span id="dashTotalClientes">0</span> reg.</div>
                </button>
            </div>

            <div class="flex gap-3 mb-8">
                <button id="btnNewProduct" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl shadow-lg shadow-blue-200 transition font-medium flex justify-center items-center gap-2 cursor-pointer active:scale-95"><i class="fas fa-plus"></i> Producto</button>
                <button id="btnNewSale" class="flex-1 bg-gray-900 hover:bg-gray-800 text-white py-3 rounded-xl shadow-lg shadow-gray-300 transition font-medium flex justify-center items-center gap-2 cursor-pointer active:scale-95"><i class="fas fa-plus"></i> Venta</button>
                <button id="btnNewExpense" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl shadow-lg shadow-red-200 transition font-medium flex justify-center items-center gap-2 cursor-pointer active:scale-95"><i class="fas fa-minus"></i> Gasto</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-border-l border-blue-500 relative protected-section" data-protected="salesMonth">
                    <div class="flex justify-between items-start mb-2"><div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Ventas (Mes)</div><button class="text-gray-400 hover:text-blue-600 cursor-pointer" data-toggle-privacy="sales"><i class="fas fa-eye"></i></button></div>
                    <div class="text-2xl font-bold text-gray-900" id="cardVentasMes">$0.00</div>
                    <div class="mt-2 text-xs text-green-600 flex items-center"><i class="fas fa-calendar-day mr-1"></i> Hoy: <span id="cardVentasHoy" class="ml-1 font-semibold">$0.00</span></div>
                </div>
                
                <!-- MODIFICADO: Tarjeta de Ganancia Neta con PIN y asteriscos -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-border-l border-green-500 relative protected-section" data-protected="netProfit">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Ganancia Neta (Mes)</div>
                        <button id="toggleNetProfitBtn" class="text-gray-400 hover:text-green-600 cursor-pointer" data-toggle-privacy="netProfit">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">
                        <span id="cardGananciaMesHidden" class="hidden-value">******</span>
                        <span id="cardGananciaMes" class="hidden">$0.00</span>
                    </div>
                    <div class="mt-2 text-xs text-gray-500 flex items-center">Ventas - Gastos</div>
                    <!-- Indicador de estado -->
                    <div id="netProfitStatus" class="absolute bottom-2 right-2 text-xs">
                        <span class="bg-red-100 text-red-600 px-2 py-1 rounded-full hidden" id="netProfitLocked">
                            <i class="fas fa-lock mr-1"></i> Bloqueado
                        </span>
                        <span class="bg-green-100 text-green-600 px-2 py-1 rounded-full hidden" id="netProfitUnlocked">
                            <i class="fas fa-unlock mr-1"></i> Desbloqueado
                        </span>
                    </div>
                </div>
                
                <!-- CAMBIO: Ahora es CUMULATIVO y Persistente -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-border-l border-yellow-500 relative">
                    <div class="flex justify-between items-start mb-2"><div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Caja S√ìLO EFECTIVO (ACUMULADO)</div><button class="text-gray-400 hover:text-yellow-600 cursor-pointer" id="btnOpenCashModal"><i class="fas fa-external-link-alt"></i></button></div>
                    <div class="text-2xl font-bold text-gray-900" id="cardCaja">$0.00</div>
                    <div class="mt-2 text-xs text-yellow-600 font-semibold">Click √≠cono para detalle y ajustes</div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-border-l border-orange-500 relative">
                    <div class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Stock Total</div>
                    <div class="text-2xl font-bold text-gray-900" id="cardStockUnidades">0</div>
                    <div class="mt-2 text-xs text-gray-500">Unidades F√≠sicas</div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-8">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-bullhorn text-purple-500"></i> Notas / Novedades</h3>
                <div class="flex gap-2">
                    <textarea id="dailyNoteInput" rows="2" class="input-std" placeholder="Escribe un recordatorio o novedad del d√≠a..."></textarea>
                    <div class="flex flex-col gap-2 justify-center">
                        <button id="saveNoteBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg shadow-sm transition font-medium cursor-pointer h-full" title="Guardar en historial"><i class="fas fa-save"></i></button>
                        <button id="sendWhatsappBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg shadow-sm transition font-medium cursor-pointer h-full" title="Enviar por WhatsApp"><i class="fab fa-whatsapp text-xl"></i></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALES -->

    <div id="listManagerModal" class="modal-overlay fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl"><h3 class="font-bold text-gray-700">Gestionar Lista</h3><button data-close="listManagerModal" class="text-gray-400"><i class="fas fa-times"></i></button></div>
            <div class="p-4">
                <p class="text-xs text-gray-500 mb-2">Haz clic en el √≠cono de basura para **BLOQUEAR** un elemento de las listas desplegables (requiere recarga para aparecer en la lista de bloqueados).</p>
                <ul id="listManagerItems" class="space-y-2 max-h-60 overflow-y-auto"></ul>
            </div>
        </div>
    </div>

    <!-- MODAL TUTORIALES (NUEVO) -->
    <div id="tutorialsModal" class="modal-overlay fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden">
            <div class="p-6 bg-blue-600 text-white flex justify-between items-center rounded-t-2xl">
                <h2 class="text-2xl font-bold"><i class="fas fa-graduation-cap mr-2"></i> Tutorial de Uso R√°pido</h2>
                <button data-close="tutorialsModal" class="text-white opacity-80 hover:opacity-100 text-2xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                
                <h3 class="text-2xl font-extrabold text-gray-900 border-b pb-2 mb-4">Registro de Transacciones</h3>
                
                <div class="border-b pb-4">
                    <h4 class="text-xl font-bold text-blue-700 mb-3"><i class="fas fa-shopping-cart mr-2"></i> 1. Registrar una Venta</h4>
                    <p class="text-gray-700 mb-3">La funci√≥n principal es registrar cada venta de forma correcta para calcular comisiones y caja.</p>
                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-600 bg-blue-50 p-4 rounded-xl border border-blue-200">
                        <li><span class="font-bold">Acceso:</span> Pulsa el bot√≥n grande que dice <span class="bg-gray-900 text-white px-2 py-1 rounded text-xs font-mono">Venta</span> en el Panel de Control.</li>
                        <li><span class="font-bold">Datos Cruciales:</span>
                            <ul class="list-disc list-inside ml-5">
                                <li><span class="font-medium">Monto ($):</span> El valor final cobrado.</li>
                                <li><span class="font-medium">Producto y Cantidad:</span> Debes seleccionar el producto del **Inventario** y la **Cantidad Vendida** (esto resta del stock).</li>
                                <li><span class="font-medium">Cliente:</span> Nombre (Si es cliente nuevo, se agrega autom√°ticamente a la Base de Clientes).</li>
                                <li><span class="font-medium">Encargado:</span> Tu nombre (¬°Crucial para tu comisi√≥n!).</li>
                                <li><span class="font-medium">Pago:</span> Tipo de pago (Efectivo, Tarjeta, Nave, etc.).</li>
                            </ul>
                        </li>
                        <!-- NOTA: Aqu√≠ est√°n implementadas las comisiones de Yael -->
                        <li><span class="font-bold text-red-600">Comisiones:</span> Si la encargada es Yael, se aplica un 3% para pagos con QR, Nave, T. Cr√©dito o T. D√©bito, y 7% para los dem√°s. Para otros encargados la comisi√≥n es 0%.</li>
                    </ul>
                </div>
                
                <div class="border-b pb-4">
                    <h4 class="text-xl font-bold text-blue-700 mb-3"><i class="fas fa-minus-circle mr-2"></i> 2. Registrar un Gasto</h4>
                    <p class="text-gray-700 mb-3">Si pagas algo del negocio con dinero de la caja, debe quedar registrado como Gasto.</p>
                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-600 bg-red-50 p-4 rounded-xl border border-red-200">
                        <li><span class="font-bold">Acceso:</span> Pulsa el bot√≥n rojo <span class="bg-red-500 text-white px-2 py-1 rounded text-xs font-mono">Gasto</span>.</li>
                        <li><span class="font-bold">Monto y Categor√≠a:</span> Indica el monto y selecciona una categor√≠a (ej: 'Mercader√≠a', 'Alquiler').</li>
                        <li><span class="font-bold">M√©todo de Pago:</span> Indica con qu√© se pag√≥ (Efectivo, Transferencia, etc.).</li>
                        <li><span class="font-bold">Efecto:</span> Esto resta del dinero disponible en la <span class="font-bold text-yellow-700">Caja Actual</span>.</li>
                    </ul>
                </div>

                <div class="border-b pb-4">
                    <h4 class="text-xl font-bold text-blue-700 mb-3"><i class="fas fa-box-open mr-2"></i> 3. Agregar/Actualizar Inventario</h4>
                    <p class="text-gray-700 mb-3">Registra nuevos productos o actualiza los existentes para tener control de stock y precios.</p>
                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-600 bg-orange-50 p-4 rounded-xl border border-orange-200">
                        <li><span class="font-bold">Acceso:</span> Pulsa el bot√≥n azul <span class="bg-blue-600 text-white px-2 py-1 rounded text-xs font-mono">Producto</span>.</li>
                        <li><span class="font-bold">Datos:</span> Ingresa el Nombre, Tipo, Precio ARS/USD y el Stock.</li>
                        <li><span class="font-bold">Visualizaci√≥n:</span> Puedes ver todo el inventario en la tarjeta de <span class="font-bold text-orange-600">Inventario</span>.</li>
                    </ul>
                </div>

                <h3 class="text-2xl font-extrabold text-gray-900 border-b pb-2 mb-4">Historiales y Consultas</h3>

                <div class="border-b pb-4">
                    <h4 class="text-xl font-bold text-blue-700 mb-3"><i class="fas fa-history mr-2"></i> 4. Ver Historiales (Ventas, Gastos, Inventario, Clientes)</h4>
                    <p class="text-gray-700 mb-3">Los historiales se acceden haciendo clic en las tarjetas del Panel de Control (ej: 'Ver Ventas', 'Ver Gastos').</p>
                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-600 bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <li><span class="font-bold">Uso de Filtros:</span> Todos los historiales tienen campos de filtro (<i class="fas fa-filter"></i>). Puedes filtrar por **Fecha, Mes o A√±o** y por palabras clave (ej: nombre del cliente o encargado).</li>
                        <li><span class="font-bold">Gr√°ficos:</span> Tienen un bot√≥n para mostrar un gr√°fico visual de la distribuci√≥n (por tiempo o tipo de pago/producto).</li>
                        <li><span class="font-bold text-purple-600">Seguridad con PIN:</span> Algunas secciones pueden estar protegidas con PIN. Si ves un candado, necesitar√°s ingresar el PIN para acceder.</li>
                    </ul>
                </div>

                <div class="border-b pb-4">
                    <h4 class="text-xl font-bold text-blue-700 mb-3"><i class="fas fa-users-cog mr-2"></i> 5. Sueldos, Horas y Retiros de Empleados</h4>
                    <p class="text-gray-700 mb-3">Esta es una secci√≥n privada para ver el rendimiento del equipo y el estado de la Caja.</p>
                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-600 bg-indigo-50 p-4 rounded-xl border border-indigo-200">
                        <li><span class="font-bold">Retiros y Caja:</span>
                            <ul>
                                <li>Para ver el detalle de retiros, haz clic en el √≠cono <i class="fas fa-external-link-alt"></i> en la tarjeta <span class="font-bold text-yellow-700">Caja Actual</span>. Ah√≠ tambi√©n registras nuevos retiros.</li>
                                <!-- NOTA: El historial de ajustes ya existe en el modal de caja -->
                                <li><span class="font-bold text-green-600">Historial de Ajustes y Retiros:</span> En el mismo modal de caja, puedes ver todos los movimientos (retiros manuales y ajustes).</li>
                            </ul>
                        </li>
                        <li><span class="font-bold">Sueldos y Horas:</span>
                            <ul>
                                <li>Desde el Men√∫ Lateral, pulsa <span class="font-bold text-indigo-700">Ver Sueldos y Horas</span>.</li>
                                <li>Aqu√≠ ver√°s un resumen de la Comisi√≥n Estimada (calculada por el sistema) y el total de Retiros hechos por cada empleado en el per√≠odo filtrado.</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <h3 class="text-2xl font-extrabold text-gray-900 border-b pb-2 mb-4 mt-6">Ajustes y Utilidades</h3>

                <div class="border-b pb-4">
                    <h4 class="text-xl font-bold text-blue-700 mb-3"><i class="fas fa-sign-in-alt mr-2"></i> 6. Iniciar/Cerrar Sesi√≥n y Perfil</h4>
                    <p class="text-gray-700 mb-3">La aplicaci√≥n utiliza tu cuenta para guardar tus datos de forma segura. Si ves datos de prueba, inicia sesi√≥n.</p>
                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-600 bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <li><span class="font-bold">Acceso:</span> Pulsa el √≠cono de perfil (<i class="fas fa-user-circle"></i>) en la esquina superior derecha.</li>
                        <li><span class="font-bold">Iniciar Sesi√≥n:</span> Usa el bot√≥n de Google para iniciar sesi√≥n con tu cuenta.</li>
                    </ul>
                </div>
                
                <div class="pb-4">
                    <h4 class="text-xl font-bold text-blue-700 mb-3"><i class="fas fa-lightbulb mr-2"></i> 7. Cambiar Tema (Modo Oscuro/Claro)</h4>
                    <p class="text-gray-700 mb-3">Para mayor comodidad visual, puedes alternar entre el modo claro y oscuro.</p>
                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-600 bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <li><span class="font-bold">Ubicaci√≥n:</span> Pulsa el √≠cono de la luna (<i class="fas fa-moon"></i>) o sol (<i class="fas fa-sun"></i>) en la barra superior de navegaci√≥n.</li>
                        <li>El cambio se guarda autom√°ticamente.</li>
                    </ul>
                </div>

                <div class="border-t pt-4">
                    <h4 class="text-xl font-bold text-purple-700 mb-3"><i class="fas fa-lock mr-2"></i> 8. Configuraci√≥n de PIN</h4>
                    <p class="text-gray-700 mb-3">Puedes proteger secciones sensibles del sistema con un PIN de 4 d√≠gitos.</p>
                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-600 bg-purple-50 p-4 rounded-xl border border-purple-200">
                        <li><span class="font-bold">Configurar PIN:</span> Desde el Men√∫ Lateral, selecciona <span class="font-bold text-purple-700">Configurar PIN</span>.</li>
                        <li><span class="font-bold">Secciones Protegibles:</span> Puedes proteger: Ver Ventas, Ver Rentabilidad, Ganancia Bruta, Caja Real, Ventas del Mes y Ganancia Neta.</li>
                        <li><span class="font-bold">Ganancia Neta con Asteriscos:</span> La tarjeta de Ganancia Neta muestra asteriscos cuando est√° protegida. Al tocar el ojo üëÅÔ∏è y verificar el PIN, se muestran los n√∫meros reales.</li>
                        <li><span class="font-bold">Detalles Diarios:</span> Accede a informaci√≥n detallada de ventas, gastos y m√©todos de pago por d√≠a desde el men√∫ lateral.</li>
                    </ul>
                </div>

                <!-- NUEVA SECCI√ìN: NIVEL 1 - MODO JOYSTICK -->
                <div class="border-t pt-4">
                    <h4 class="text-xl font-bold text-green-700 mb-3"><i class="fas fa-gamepad mr-2"></i> 9. Nivel 1 - Modo Joystick üïπÔ∏è</h4>
                    <p class="text-gray-700 mb-3">Controla al jugador con un joystick virtual t√°ctil para una experiencia de juego inmersiva.</p>
                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-600 bg-green-50 p-4 rounded-xl border border-green-200">
                        <li><span class="font-bold">Acceso:</span> Desde el Men√∫ Lateral, selecciona <span class="font-bold text-green-700">Nivel 1 - Modo Joystick</span>.</li>
                        <li><span class="font-bold">Controles:</span>
                            <ul class="list-disc list-inside ml-5">
                                <li><strong>Joystick Virtual:</strong> Arrastra el joystick en cualquier direcci√≥n para mover al jugador.</li>
                                <li><strong>Bot√≥n de Salto:</strong> Presiona el bot√≥n verde para hacer que el jugador salte.</li>
                                <li><strong>Bot√≥n de Acci√≥n:</strong> Presiona el bot√≥n rojo para habilidades especiales.</li>
                            </ul>
                        </li>
                        <li><span class="font-bold">Objetivos:</span>
                            <ul class="list-disc list-inside ml-5">
                                <li>Recolecta monedas amarillas para aumentar tu puntuaci√≥n.</li>
                                <li>Evita los obst√°culos rojos para no perder salud.</li>
                                <li>Mant√©n al jugador centrado en la pantalla para mejor control.</li>
                            </ul>
                        </li>
                        <li><span class="font-bold">Caracter√≠sticas:</span>
                            <ul class="list-disc list-inside ml-5">
                                <li>Movimiento suave y responsivo con el joystick.</li>
                                <li>Sistema de part√≠culas para efectos visuales.</li>
                                <li>Detecci√≥n de colisiones en tiempo real.</li>
                                <li>Puntuaci√≥n y estad√≠sticas en tiempo real.</li>
                            </ul>
                        </li>
                    </ul>
                </div>

            </div>
            <div class="p-4 border-t bg-gray-50 text-center">
                <p class="text-xs text-gray-500">¬°Recuerda mantener toda la informaci√≥n al d√≠a para un c√°lculo de comisiones perfecto!</p>
            </div>
        </div>
    </div>
    
    <!-- MODAL CALCULADORA PORCENTAJES (NUEVO) -->
    <div id="calculatorModal" class="modal-overlay fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="p-4 bg-gray-900 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-calculator mr-2"></i> Calculadora</h3>
                <button data-close="calculatorModal" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Monto Base</label>
                    <input type="number" id="calcBaseAmount" class="input-std font-bold text-lg text-center" step="0.01">
                </div>
                <div class="flex gap-2 items-center justify-center">
                    <button id="calcTypeSurcharge" class="flex-1 py-2 rounded-lg border-2 border-transparent bg-blue-100 text-blue-700 font-bold text-sm hover:bg-blue-200 transition ring-2 ring-blue-500">RECARGO (+)</button>
                    <button id="calcTypeDiscount" class="flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-100 text-gray-600 font-bold text-sm hover:bg-green-100 hover:text-green-700 transition">DESCUENTO (-)</button>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Porcentaje (%)</label>
                    <div class="flex gap-2">
                        <button class="bg-gray-100 px-3 py-2 rounded-lg text-xs font-bold hover:bg-gray-200" onclick="$('calcPercentage').value=10; updateCalc();">10%</button>
                        <button class="bg-gray-100 px-3 py-2 rounded-lg text-xs font-bold hover:bg-gray-200" onclick="$('calcPercentage').value=15; updateCalc();">15%</button>
                        <button class="bg-gray-100 px-3 py-2 rounded-lg text-xs font-bold hover:bg-gray-200" onclick="$('calcPercentage').value=21; updateCalc();">21%</button>
                        <input type="number" id="calcPercentage" class="input-std text-center font-bold" placeholder="0" oninput="updateCalc()">
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-xl text-center border border-gray-100">
                    <div class="text-xs text-gray-400 uppercase font-bold mb-1">Resultado Final</div>
                    <div id="calcResultDisplay" class="text-3xl font-bold text-gray-800">$0.00</div>
                </div>
                <button id="applyCalcResultBtn" class="w-full bg-gray-900 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-gray-800 transition transform active:scale-95">Aplicar Resultado</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL HISTORIAL DE NOVEDADES -->
    <div id="newsHistoryModal" class="modal-overlay fixed inset-0 z-[80] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-bell text-blue-500 mr-2"></i> Historial de Novedades</h2>
                <button data-close="newsHistoryModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div id="newsListContainer" class="space-y-3">
                    <div class="text-center text-gray-400 py-4">No hay novedades registradas.</div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 text-right">
                <button data-close="newsHistoryModal" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="employeeStatsModal" class="modal-overlay fixed inset-0 z-[80] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-indigo-50 rounded-t-2xl"><h2 class="text-xl font-bold text-indigo-800"><i class="fas fa-user-clock mr-2"></i> Rendimiento y Pagos</h2><button data-close="employeeStatsModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button></div>
            <div class="p-6 bg-white border-b flex flex-wrap gap-2 items-center">
                <span class="text-xs text-gray-400 font-bold uppercase mr-1">Filtrar por:</span>
                <input type="date" id="filterStatsDate" class="input-std w-auto text-sm" title="Seleccionar d√≠a espec√≠fico">
                <span class="text-xs text-gray-300 mx-1">|</span>
                <select id="filterStatsMonth" class="input-std w-32 text-sm"><option value="all">Mes: Todos</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option></select>
                <select id="filterStatsYear" class="input-std w-24 text-sm"><option value="all">A√±o</option><option value="2025">2025</option><option value="2024">2024</option></select>
                <button id="applyStatsFilter" class="bg-indigo-600 text-white px-3 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition" title="Aplicar Filtros"><i class="fas fa-filter"></i></button>
                <button id="resetStatsFilter" class="bg-gray-100 text-gray-500 px-3 py-2 rounded-lg hover:bg-gray-200 transition" title="Limpiar Filtros"><i class="fas fa-undo"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-0"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50 sticky top-0"><tr><th class="table-header">Empleado</th><th class="table-header text-center">Turnos</th><th class="table-header text-center">Horas</th><th class="table-header text-right">Comisi√≥n Estimada</th><th class="table-header text-right">Retiros</th><th class="table-header text-center">Acciones</th></tr></thead><tbody id="employeeStatsTableBody" class="bg-white divide-y divide-gray-100"></tbody></table></div>
            <div class="p-4 bg-indigo-50 border-t flex justify-between items-center gap-4">
                <div class="flex items-center gap-2"><span class="text-sm text-indigo-800 font-medium">Comisi√≥n Est. (Per√≠odo):</span><span class="text-xl font-bold text-green-600" id="statsTotalCommission">$0.00</span></div>
                <div class="flex items-center gap-2"><span class="text-sm text-indigo-800 font-medium">Total Retiros (Per√≠odo):</span><span class="text-xl font-bold text-red-600" id="statsTotalWithdrawals">$0.00</span></div>
            </div>
        </div>
    </div>

    <!-- MODAL HISTORIAL GANANCIAS -->
    <div id="gananciasDetailModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-green-50 rounded-t-2xl">
                <div><h2 class="text-xl font-bold text-green-800">Historial de Rentabilidad</h2><div class="text-sm font-medium mt-1" id="profitHeaderSummary">Cargando...</div></div>
                <button data-close="gananciasDetailModal" class="text-gray-400 text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 bg-white border-b flex flex-wrap gap-2 items-center justify-between">
                <div class="flex gap-2 items-center">
                    <select id="filterProfitMonth" class="input-std w-32 text-sm"><option value="all">Mes: Todos</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option></select>
                    <select id="filterProfitYear" class="input-std w-24 text-sm"><option value="all">A√±o: Todos</option><option value="2025">2025</option><option value="2024">2024</option></select>
                    <button id="applyProfitFilterBtn" class="bg-green-600 text-white px-3 py-2 rounded-lg"><i class="fas fa-filter"></i></button>
                </div>
                <!-- Toggle Button Ganancias -->
                <button onclick="toggleChart('profit')" class="text-green-600 border border-green-200 px-3 py-1 rounded-lg hover:bg-green-50 transition text-sm font-bold flex items-center gap-2"><i class="fas fa-chart-area"></i> Ver Gr√°fico</button>
            </div>
            <!-- Contenedor Chart Ganancias (Oculto por defecto) -->
            <div id="profitChartWrapper" class="hidden p-4 bg-white border-b">
                <div style="height: 220px; width: 100%; position: relative;"><canvas id="profitChart"></canvas></div>
            </div>
            <div class="overflow-y-auto flex-1 p-0">
                <table class="min-w-full divide-y divide-gray-200 massive-sale-table"><thead class="bg-gray-50 sticky top-0"><tr><th class="table-header sortable-header" onclick="sortTable('profit', 'date')">Fecha <span class="sort-arrow" id="profitSortDate">‚Üï</span></th><th class="table-header text-right sortable-header" onclick="sortTable('profit', 'sales')">Ventas <span class="sort-arrow" id="profitSortSales">‚Üï</span></th><th class="table-header text-right sortable-header" onclick="sortTable('profit', 'expenses')">Gastos <span class="sort-arrow" id="profitSortExpenses">‚Üï</span></th><th class="table-header text-right sortable-header" onclick="sortTable('profit', 'balance')">Balance Neto <span class="sort-arrow" id="profitSortBalance">‚Üï</span></th><th class="table-header text-center">Acciones</th></tr></thead><tbody id="profitTableBody" class="bg-white divide-y divide-gray-100"></tbody></table>
            </div>
        </div>
    </div>
    
    <!-- MODAL HISTORIAL VENTAS - ACTUALIZADO CON FILTRO DE CANAL Y ORDENAMIENTO -->
    <div id="salesHistoryModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-blue-50 rounded-t-2xl"><div><h2 class="text-xl font-bold text-blue-700">Historial de Ventas</h2><p class="text-sm text-blue-500" id="salesHistoryTotalLabel">Total: $0.00</p></div><button data-close="salesHistoryModal" class="text-gray-400 text-xl"><i class="fas fa-times"></i></button></div>
            <div class="p-4 bg-white border-b flex flex-wrap gap-2 items-center justify-between">
                <div class="flex flex-wrap gap-2 items-center">
                    <input type="text" id="searchSaleInput" placeholder="Cliente o Empleado..." class="input-std w-40">
                    <!-- NUEVO FILTRO DE CANAL -->
                    <select id="filterSaleChannel" class="input-std w-32 text-sm">
                        <option value="all">Canal: Todos</option>
                        <!-- Las opciones se llenar√°n din√°micamente -->
                    </select>
                    <div class="border-l pl-2 flex gap-2 items-center">
                        <span class="text-xs text-gray-400 font-bold">FECHA:</span><input type="date" id="filterSaleDate" class="input-std w-auto text-sm">
                        <span class="text-xs text-gray-400">O</span>
                        <select id="filterSaleMonth" class="input-std w-32 text-sm"><option value="all">Mes: Todos</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option></select>
                        <select id="filterSaleYear" class="input-std w-24 text-sm"><option value="all">A√±o</option><option value="2025">2025</option><option value="2024">2024</option></select>
                        <button id="applySalesFilter" class="bg-blue-600 text-white px-3 py-2 rounded-lg"><i class="fas fa-filter"></i></button>
                        <button id="resetSalesFilter" class="bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-undo"></i></button>
                    </div>
                </div>
                <!-- Botones de Gr√°ficos (ACTUALIZADO) -->
                <div class="flex gap-2">
                    <button id="toggleSalesTimeChart" class="text-blue-600 border border-blue-200 px-3 py-1 rounded-lg hover:bg-blue-50 transition text-sm font-bold flex items-center gap-2"><i class="fas fa-chart-bar"></i> Ventas por Tiempo</button>
                    <button id="togglePaymentTypeChart" class="text-gray-600 border border-gray-200 px-3 py-1 rounded-lg hover:bg-gray-50 transition text-sm font-bold flex items-center gap-2"><i class="fas fa-chart-pie"></i> Pagos por Tipo</button>
                </div>
            </div>

            <!-- Chart Ventas por Tiempo Wrapper (Original) -->
            <div id="salesChartWrapper" class="hidden p-4 bg-white border-b">
                <div class="flex justify-center mb-2 gap-2">
                    <button class="px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-600 font-bold hover:bg-blue-200 transition" onclick="updateChartMode('daily')">Diario</button>
                    <button class="px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition" onclick="updateChartMode('monthly')">Mensual</button>
                    <button class="px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition" onclick="updateChartMode('yearly')">Anual</button>
                </div>
                <div style="height: 200px; position: relative; width: 100%;"><canvas id="salesChart"></canvas></div>
            </div>

            <!-- Chart Pagos por Tipo Wrapper (NUEVO) -->
            <div id="paymentTypeChartWrapper" class="hidden p-4 bg-white border-b flex justify-center">
                <div style="height: 250px; width: 100%; max-width: 400px; position: relative;"><canvas id="paymentTypeChart"></canvas></div>
            </div>

            <div class="flex-1 overflow-y-auto p-0">
                <table class="min-w-full divide-y divide-gray-200 massive-sale-table">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="table-header sortable-header" onclick="sortTable('sales', 'date')">Fecha / Hora <span class="sort-arrow" id="salesSortDate">‚Üï</span></th>
                            <th class="table-header sortable-header" onclick="sortTable('sales', 'client')">Cliente <span class="sort-arrow" id="salesSortClient">‚Üï</span></th>
                            <th class="table-header sortable-header" onclick="sortTable('sales', 'product')">Producto Vendido <span class="sort-arrow" id="salesSortProduct">‚Üï</span></th>
                            <th class="table-header sortable-header" onclick="sortTable('sales', 'quantity')">Cantidad <span class="sort-arrow" id="salesSortQuantity">‚Üï</span></th>
                            <th class="table-header sortable-header" onclick="sortTable('sales', 'payment')">Pago <span class="sort-arrow" id="salesSortPayment">‚Üï</span></th>
                            <th class="table-header sortable-header" onclick="sortTable('sales', 'employee')">Encargado / Turno <span class="sort-arrow" id="salesSortEmployee">‚Üï</span></th>
                            <th class="table-header text-right sortable-header" onclick="sortTable('sales', 'amount')">Monto <span class="sort-arrow" id="salesSortAmount">‚Üï</span></th>
                            <th class="table-header text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody" class="bg-white divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL HISTORIAL GASTOS CON ORDENAMIENTO -->
    <div id="expensesHistoryModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center"><h2 class="text-xl font-bold text-red-600">Historial de Gastos</h2><p class="text-sm text-red-500" id="expensesHistoryTotalLabel">Total: $0.00</p><button data-close="expensesHistoryModal" class="text-gray-400 text-xl"><i class="fas fa-times"></i></button></div>
            <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-2 items-center justify-between">
                <div class="flex flex-wrap gap-2 items-center">
                    <input type="text" id="searchExpenseInput" placeholder="Cat. o Encargado..." class="input-std w-40">
                    <div class="border-l pl-2 flex gap-2 items-center">
                        <input type="date" id="filterExpenseDate" class="input-std w-auto text-sm">
                        <select id="filterExpenseMonth" class="input-std w-32 text-sm"><option value="all">Mes: Todos</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option></select>
                        <select id="filterExpenseYear" class="input-std w-24 text-sm"><option value="all">A√±o</option><option value="2025">2025</option><option value="2024">2024</option></select>
                        <button id="applyExpenseFilter" class="bg-red-500 text-white px-3 py-2 rounded-lg"><i class="fas fa-filter"></i></button>
                        <button id="resetExpenseFilter" class="bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-undo"></i></button>
                    </div>
                </div>
                <!-- Toggle Button Gastos -->
                <button onclick="toggleChart('expenses')" class="text-red-600 border border-red-200 px-3 py-1 rounded-lg hover:bg-red-50 transition text-sm font-bold flex items-center gap-2"><i class="fas fa-chart-bar"></i> Ver Gr√°fico</button>
            </div>
            <!-- Chart Gastos Wrapper (Oculto por defecto) -->
            <div id="expensesChartWrapper" class="hidden p-4 bg-white border-b">
                   <div style="height: 200px; position: relative; width: 100%;"><canvas id="expensesChart"></canvas></div>
            </div>
            <div class="flex-1 overflow-y-auto p-0">
                <table class="min-w-full divide-y divide-gray-200 massive-sale-table">
                    <thead>
                        <tr>
                            <th class="table-header sortable-header" onclick="sortTable('expenses', 'date')">Fecha <span class="sort-arrow" id="expensesSortDate">‚Üï</span></th>
                            <th class="table-header sortable-header" onclick="sortTable('expenses', 'category')">Categor√≠a <span class="sort-arrow" id="expensesSortCategory">‚Üï</span></th>
                            <th class="table-header sortable-header" onclick="sortTable('expenses', 'payment')">Pago <span class="sort-arrow" id="expensesSortPayment">‚Üï</span></th>
                            <th class="table-header sortable-header" onclick="sortTable('expenses', 'manager')">Encargado <span class="sort-arrow" id="expensesSortManager">‚Üï</span></th>
                            <th class="table-header text-right sortable-header" onclick="sortTable('expenses', 'amount')">Monto <span class="sort-arrow" id="expensesSortAmount">‚Üï</span></th>
                            <th class="table-header text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody" class="bg-white divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL CAJA ACTUAL (ACTUALIZADO con Ajustes y Scrollbar mejorado) -->
    <!-- MEJORADO: A√±adida clase para scroll t√°ctil y barra deslizadora mejorada -->
    <div id="cashDetailModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl flex flex-col max-h-[90vh] overflow-y-auto touch-scroll">
            <div class="p-6 border-b flex justify-between items-center bg-yellow-50 rounded-t-2xl sticky top-0 z-10 bg-white">
                <h2 class="text-xl font-bold text-yellow-700">Arqueo de Caja - Historial de Movimientos</h2>
                <button data-close="cashDetailModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button>
            </div>
            <!-- ACTUALIZADO: Div para los 4 totales -->
            <div class="p-6 border-b grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <!-- Caja Solo Efectivo: Muestra el total filtrado -->
                <div class="bg-yellow-100 p-3 rounded-lg border-2 border-yellow-300">
                    <div class="text-xs text-yellow-700 font-bold uppercase">Caja S√ìLO EFECTIVO (FILTRADO)</div>
                    <div class="text-lg font-bold text-yellow-800" id="cashModalOnlyCash">$0.00</div>
                </div>
                <!-- Ganancia Bruta con PIN -->
                <div class="bg-green-50 p-3 rounded-lg protected-section" data-protected="grossProfit">
                    <div class="text-xs text-green-600 font-bold uppercase">Ganancia Bruta</div>
                    <div class="text-lg font-bold text-green-800" id="cashModalGross">$0.00</div>
                </div>
                <div class="bg-red-50 p-3 rounded-lg">
                    <div class="text-xs text-red-600 font-bold uppercase">Retiros Manuales</div>
                    <div class="text-lg font-bold text-red-800" id="cashModalWithdrawals">$0.00</div>
                </div>
                <!-- Caja Real con PIN -->
                <div class="bg-yellow-50 p-3 rounded-lg border-2 border-yellow-200 protected-section" data-protected="cashReal">
                    <div class="text-xs text-yellow-600 font-bold uppercase">En Caja Real</div>
                    <div class="2xl font-bold text-yellow-800" id="cashModalNet">$0.00</div>
                </div>
            </div>
            
            <!-- FILTROS - APLICAN A RETIROS Y AJUSTES -->
            <div class="p-4 bg-yellow-50 border-b flex flex-wrap gap-2 items-center sticky top-0 z-10 bg-yellow-50">
                <input type="text" id="searchCashInput" placeholder="Buscar empleado o motivo..." class="input-std w-40">
                <div class="border-l border-yellow-200 pl-2 flex gap-2 items-center">
                    <span class="text-xs text-yellow-700 font-bold">FECHA:</span><input type="date" id="filterCashDate" class="input-std w-auto text-sm"><span class="text-xs text-yellow-700">O</span><select id="filterCashMonth" class="input-std w-32 text-sm"><option value="all">Mes: Todos</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julzo</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option value="11">Diciembre</option></select><select id="filterCashYear" class="input-std w-24 text-sm"><option value="all">A√±o</option><option value="2025">2025</option><option value="2024">2024</option></select><button id="applyCashFilter" class="bg-yellow-600 text-white px-3 py-2 rounded-lg" title="Aplicar filtro"><i class="fas fa-filter"></i></button><button id="resetCashFilter" class="bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300" title="Borrar filtro"><i class="fas fa-undo"></i></button>
                </div>
                <div class="ml-auto text-sm font-bold text-yellow-800 border-l border-yellow-300 pl-3">Flujo Cash Filtrado: <span id="cashFilteredTotal" class="text-yellow-800">$0.00</span></div>
            </div>

            <!-- FORMULARIOS: RETIRO MANUAL Y AJUSTE MANUAL -->
            <div class="p-4 bg-gray-100 border-b grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- RETIRO MANUAL -->
                <form id="withdrawalForm" class="bg-red-50 p-3 rounded-xl border border-red-200 space-y-2">
                    <h3 class="font-bold text-red-700"><i class="fas fa-sign-out-alt mr-1"></i> Retiro de Caja (Egreso)</h3>
                    <div class="flex gap-2">
                        <input type="date" id="wdDate" class="input-std w-32" value="">
                        <input type="number" id="wdAmount" placeholder="Monto (-)" class="input-std w-32 text-red-600 font-bold" required>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="wdEmployee" list="managerList" placeholder="Empleado..." class="input-std flex-1" required>
                    </div>
                    <input type="text" id="wdNote" placeholder="Motivo del retiro..." class="input-std">
                    <button type="submit" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">Registrar Retiro</button>
                </form>

                <!-- AJUSTE MANUAL (NUEVO) -->
                <form id="adjustmentForm" class="bg-green-50 p-3 rounded-xl border border-green-200 space-y-2">
                    <h3 class="font-bold text-green-700"><i class="fas fa-hand-holding-usd mr-1"></i> Ajuste Manual (Ingreso / Egreso)</h3>
                    <div class="flex gap-2">
                        <input type="date" id="adjDate" class="input-std w-32" value="">
                        <input type="number" id="adjAmount" placeholder="Monto (+/-)" class="input-std w-32 font-bold" required>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="adjEmployee" list="managerList" placeholder="Encargado..." class="input-std flex-1" required>
                    </div>
                    <input type="text" id="adjNote" placeholder="Motivo del ajuste (ej: 'Error en conteo', 'Fondo inicial')..." class="input-std" required>
                    <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">Guardar Ajuste</button>
                </form>
            </div>
            
            <!-- TABLA DE MOVIMIENTOS - ACTUALIZADA CON FECHAS -->
            <div class="flex-1 overflow-y-auto p-0">
                <table class="min-w-full divide-y divide-gray-200 mobile-cash-table">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Movimiento</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Encargado / Motivo</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Monto ($)</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="cashMovementsTableBody" class="bg-white divide-y divide-gray-100">
                        <!-- Aqu√≠ se renderizar√°n Retiros (withdrawal) y Ajustes (adjustment) -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL INVENTARIO -->
    <div id="inventoryModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-orange-50 rounded-t-2xl"><h2 class="text-xl font-bold text-orange-600">Inventario</h2><button data-close="inventoryModal" class="text-gray-400 text-xl"><i class="fas fa-times"></i></button></div>
            <div class="p-4 bg-white border-b flex flex-wrap gap-2 items-center justify-between">
                <div class="flex flex-wrap gap-2 items-center">
                    <input type="text" id="searchInventoryInput" placeholder="Buscar producto..." class="input-std w-40">
                    <div class="border-l pl-2 flex gap-2 items-center">
                        <span class="text-xs text-gray-400 font-bold">CREADO:</span><input type="date" id="filterInvDate" class="input-std w-auto text-sm"><select id="filterInvMonth" class="input-std w-32 text-sm"><option value="all">Mes: Todos</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option></select><select id="filterInvYear" class="input-std w-24 text-sm"><option value="all">A√±o</option><option value="2025">2025</option><option value="2024">2024</option></select>
                        <button id="applyInvFilter" class="bg-orange-500 text-white px-3 py-2 rounded-lg"><i class="fas fa-filter"></i></button><button id="resetInvFilter" class="bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-undo"></i></button>
                    </div>
                </div>
                <!-- Toggle Button Inventario -->
                <button onclick="toggleChart('inventory')" class="text-orange-600 border border-orange-200 px-3 py-1 rounded-lg hover:bg-orange-50 transition text-sm font-bold flex items-center gap-2"><i class="fas fa-chart-pie"></i> Ver Gr√°fico</button>
            </div>
            <!-- Chart Inventario Wrapper (Oculto) -->
            <div id="inventoryChartWrapper" class="hidden p-4 bg-white border-b flex justify-center">
                   <div style="height: 250px; width: 100%; max-width: 400px; position: relative;"><canvas id="inventoryChart"></canvas></div>
            </div>
            <div class="flex-1 overflow-y-auto p-0"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="table-header">Producto</th><th class="table-header">Tipo</th><th class="table-header text-right">Stock</th><th class="table-header text-right">Precio ARS</th><th class="table-header text-right">Precio USD</th><th class="table-header text-center">Acciones</th></tr></thead><tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-100"></tbody></table></div>
        </div>
    </div>

    <!-- MODAL NUEVA VENTA (ACTUALIZADO CON STOCK, CANTIDAD Y OPCI√ìN MASIVA) -->
    <div id="newSaleModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h2 class="text-xl font-bold">Registrar Venta</h2>
                <button data-close="newSaleModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- SWITCH PARA TIPO DE VENTA -->
            <div class="p-6 border-b">
                <div class="sale-type-switch">
                    <div class="sale-type-slider" id="saleTypeSlider"></div>
                    <div class="sale-type-option active" onclick="switchSaleType('single')" data-type="single">
                        <i class="fas fa-cube mr-2"></i> Unidad
                    </div>
                    <div class="sale-type-option" onclick="switchSaleType('massive')" data-type="massive">
                        <i class="fas fa-layer-group mr-2"></i> Masiva
                    </div>
                </div>
            </div>
            
            <!-- FORMULARIO DE VENTA POR UNIDAD (POR DEFECTO) -->
            <form id="saleForm" class="p-6 space-y-4" style="display: block;">
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700">Fecha</label><input type="date" id="saleDate" class="input-std" value=""></div>
                    <div><label class="block text-sm font-medium text-gray-700">Hora</label><input type="time" id="saleTime" class="input-std" value=""></div>
                    <div><label class="block text-sm font-medium text-gray-700">Turno</label><input type="text" id="saleShift" class="input-std bg-gray-100 text-gray-500" readonly></div>
                </div>
                
                <!-- NUEVOS CAMPOS DE PRODUCTO Y CANTIDAD -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="relative col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Producto Vendido</label>
                        <select id="saleProduct" class="input-std">
                            <option value="" selected>Selecciona un producto del inventario (opcional)</option>
                        </select>
                        <span id="selectedProductType" class="text-xs text-gray-500 mt-1 block"></span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="saleQuantity" class="input-std font-bold text-lg text-center" value="1" min="1">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Encargado</label>
                        <input type="text" id="saleEmployee" list="managerList" class="input-std">
                        <datalist id="managerList"></datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Monto ($) <span class="text-red-500">*</span></label>
                        <div class="flex gap-2">
                            <input type="number" id="saleAmount" step="0.01" class="input-std font-bold text-lg" required>
                            <button type="button" id="openCalcBtn" class="bg-gray-100 px-3 rounded-lg text-gray-600 hover:bg-blue-100 hover:text-blue-600 transition" title="Calculadora de Porcentajes"><i class="fas fa-calculator"></i></button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <label class="block text-sm font-bold text-blue-700 mb-2">Cliente (opcional)</label>
                    <div class="space-y-3">
                        <input type="text" id="saleClient" list="clientList" class="input-std" placeholder="Nombre">
                        <datalist id="clientList"></datalist>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="tel" id="saleWhatsapp" class="input-std" placeholder="WhatsApp (opcional)">
                            <input type="email" id="saleEmail" class="input-std" placeholder="Email (opcional)">
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700">Pago (opcional)</label>
                        <div class="flex gap-1">
                            <input type="text" id="salePayment" list="paymentList" class="input-std" placeholder="Tipo de pago">
                            <button type="button" class="text-gray-400 hover:text-blue-600 px-2" onclick="openManager('paymentType')"><i class="fas fa-cog"></i></button>
                        </div>
                        <datalist id="paymentList"></datalist>
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700">Canal (opcional)</label>
                        <div class="flex gap-1">
                            <input type="text" id="saleChannel" list="channelList" class="input-std" placeholder="Canal de venta">
                            <button type="button" class="text-gray-400 hover:text-blue-600 px-2" onclick="openManager('salesChannel')"><i class="fas fa-cog"></i></button>
                        </div>
                        <datalist id="channelList"></datalist>
                    </div>
                </div>
                
                <!-- CAMPO DE NOTA A√ëADIDO -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nota (opcional) - Se ver√° en el historial</label>
                    <textarea id="saleNotes" rows="2" class="input-std" placeholder="Notas adicionales sobre esta venta..."></textarea>
                </div>
                
                <button type="submit" class="w-full bg-gray-900 hover:bg-gray-800 text-white py-3 rounded-xl font-bold shadow-md cursor-pointer">Guardar Venta</button>
            </form>

            <!-- FORMULARIO DE VENTA MASIVA -->
            <form id="massiveSaleForm" class="p-6 space-y-4" style="display: none;">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="massiveSaleDate" class="input-std" value="">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Encargado Predeterminado</label>
                        <input type="text" id="massiveSaleEmployee" list="managerList" class="input-std" placeholder="Encargado para todas las ventas">
                    </div>
                </div>

                <!-- TABLA DE VENTA MASIVA -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 massive-sale-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Turno</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hora</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Encargado</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unidades</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">M√©todo de Pago</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Canal de Venta</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">WhatsApp</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nota</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="massiveSaleTableBody" class="bg-white divide-y divide-gray-100">
                            <!-- Las filas se agregar√°n din√°micamente -->
                            <tr id="massiveSaleEmptyRow" class="text-center text-gray-400 py-8">
                                <td colspan="13" class="py-8">
                                    <div class="flex flex-col items-center justify-center gap-2">
                                        <i class="fas fa-layer-group text-3xl text-gray-300"></i>
                                        <p>No hay filas agregadas. Haz clic en "Agregar Fila" para comenzar.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-between items-center pt-4">
                    <button type="button" onclick="addMassiveSaleRow()" class="add-row-btn">
                        <i class="fas fa-plus"></i> Agregar Fila
                    </button>
                    <div class="text-right">
                        <div class="text-sm text-gray-600 mb-2">
                            <span class="font-bold">Total Ventas:</span> 
                            <span id="massiveSalesTotal" class="text-green-600 font-bold text-lg">$0.00</span>
                        </div>
                        <div class="text-xs text-gray-500">
                            <span id="massiveSalesCount">0</span> ventas registradas
                        </div>
                    </div>
                </div>

                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-md cursor-pointer mt-4">
                    <i class="fas fa-save mr-2"></i> Guardar Todas las Ventas
                </button>
            </form>
        </div>
    </div>
    <!-- FIN MODAL NUEVA VENTA (ACTUALIZADO) -->
    
    <!-- ACTUALIZADO: Modal Gasto con nuevo campo de m√©todo de pago -->
    <div id="newExpenseModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-xl font-bold">Registrar Gasto</h2><button data-close="newExpenseModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button></div><form id="expenseForm" class="p-6 space-y-4"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Fecha</label><input type="date" id="expenseDate" class="input-std" required></div><div><label class="block text-sm font-medium text-gray-700">Monto ($)</label><input type="number" id="expenseAmount" step="0.01" class="input-std font-bold text-lg text-red-600" required></div></div><div class="grid grid-cols-2 gap-4"><div class="relative"><label class="block text-sm font-medium text-gray-700">Categor√≠a</label><div class="flex gap-1"><input type="text" id="expenseCategory" list="categoryList" class="input-std"><button type="button" class="text-gray-400 hover:text-blue-600 px-2" onclick="openManager('category')"><i class="fas fa-cog"></i></button></div><datalist id="categoryList"></datalist></div><div class="relative"><label class="block text-sm font-medium text-gray-700">M√©todo de Pago</label><input type="text" id="expensePaymentMethod" list="expensePaymentList" class="input-std" placeholder="Efectivo, Transferencia..." required><datalist id="expensePaymentList"><option value="Efectivo"><option value="Transferencia"><option value="Tarjeta D√©bito"><option value="Tarjeta Cr√©dito"><option value="Otro"></datalist></div></div><div class="relative"><label class="block text-sm font-medium text-gray-700">Encargado</label><div class="flex gap-1"><input type="text" id="expenseManager" list="managerList" class="input-std"><button type="button" class="text-gray-400 hover:text-blue-600 px-2" onclick="openManager('manager')"><i class="fas fa-cog"></i></button></div></div><div><label class="block text-sm font-medium text-gray-700">Descripci√≥n <span class="text-xs text-gray-500">(Se ver√° en el historial de gastos)</span></label><input type="text" id="expenseDesc" class="input-std" placeholder="Descripci√≥n detallada del gasto..."></div><button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold shadow-md cursor-pointer">Guardar Gasto</button></form></div></div>
    <div id="productModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-xl font-bold">Nuevo Producto</h2><button data-close="productModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button></div><form id="productForm" class="p-6 space-y-4"><input type="text" id="prodName" placeholder="Nombre" class="input-std" required><div class="relative"><label class="block text-sm font-medium text-gray-700">Tipo</label><div class="flex gap-1"><input type="text" id="prodType" list="prodTypeList" class="input-std" required><button type="button" class="text-gray-400 hover:text-blue-600 px-2" onclick="openManager('prodType')"><i class="fas fa-cog"></i></button></div><datalist id="prodTypeList"><option value="Importado"><option value="Nacional"><option value="Nuevo"></datalist></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Precio ARS</label><input type="number" id="prodPrice" class="input-std"></div><div><label class="block text-sm font-medium text-gray-700">Precio USD</label><input type="number" id="prodPriceUsd" class="input-std"></div></div><div><label class="block text-sm font-medium text-gray-700">Stock</label><input type="number" id="prodStock" class="input-std" required></div><button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-xl font-bold cursor-pointer">Guardar</button></form></div></div>
    <div id="newClientModal" class="modal-overlay fixed inset-0 z-[60] hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-xl font-bold text-indigo-700">Nuevo Cliente</h2><button data-close="newClientModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button></div><form id="clientForm" class="p-6 space-y-4"><input type="text" id="newClientName" class="input-std" placeholder="Nombre Completo" required><input type="tel" id="newClientWhatsapp" class="input-std" placeholder="WhatsApp"><input type="email" id="newClientEmail" class="input-std" placeholder="Email"><button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-md cursor-pointer">Guardar Cliente</button></form></div></div>
    <div id="clientsModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col"><div class="p-6 border-b flex justify-between items-center bg-indigo-50 rounded-t-2xl"><h2 class="text-xl font-bold text-indigo-700">Base de Clientes</h2><button data-close="clientsModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button></div><div class="p-4 bg-white border-b flex flex-wrap gap-2 items-center"><input type="text" id="searchClientInput" placeholder="Buscar por nombre..." class="input-std w-40"><div class="border-l pl-2 flex gap-2 items-center"><select id="filterClientMonth" class="input-std w-32 text-sm"><option value="all">Mes: Todos</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option></select><select id="filterClientYear" class="input-std w-24 text-sm"><option value="all">A√±o</option><option value="2025">2025</option><option value="2024">2024</option></select><button id="applyClientFilter" class="bg-indigo-600 text-white px-3 py-2 rounded-lg"><i class="fas fa-filter"></i></button></div><button id="btnAddClientDirect" class="bg-indigo-600 text-white px-4 rounded-lg ml-auto"><i class="fas fa-plus"></i></button></div><div class="flex-1 overflow-y-auto p-0"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="table-header">Nombre</th><th class="table-header">Contacto</th><th class="table-header">Email</th><th class="table-header text-right">Historial</th><th class="table-header text-center">Acciones</th></tr></thead><tbody id="clientsTableBody" class="bg-white divide-y divide-gray-100"></tbody></table></div></div></div>
    <div id="profileModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6"><h3 class="text-lg font-bold mb-4">Perfil</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm"><p><strong>Estado:</strong> <span id="authStatusText" class="text-green-600">Conectado</span></p><p class="text-xs text-gray-400 truncate mt-1" id="uidDisplay">...</p></div><button id="googleLoginBtn" class="w-full border py-2 rounded-lg hover:bg-gray-50 mb-2 flex items-center justify-center gap-2"><i class="fab fa-google text-red-500"></i> Google Login</button><button id="logoutBtn" class="w-full bg-red-100 text-red-600 py-2 rounded-lg hover:bg-red-200">Cerrar Sesi√≥n</button><button data-close="profileModal" class="w-full mt-4 text-gray-400 text-sm">Cerrar</button></div></div>

    <!-- MODAL PARA EDITAR RETIRO -->
    <div id="editWithdrawalModal" class="modal-overlay fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b flex justify-between items-center bg-red-50 rounded-t-2xl">
                <h2 class="text-xl font-bold text-red-700"><i class="fas fa-edit mr-2"></i> Editar Retiro</h2>
                <button data-close="editWithdrawalModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button>
            </div>
            <form id="editWithdrawalForm" class="p-6 space-y-4">
                <input type="hidden" id="editWid">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="editWdDate" class="input-std" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Monto ($)</label>
                    <input type="number" id="editWdAmount" step="0.01" class="input-std font-bold text-lg text-red-600" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Empleado</label>
                    <input type="text" id="editWdEmployee" list="managerList" class="input-std" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Motivo</label>
                    <input type="text" id="editWdNote" class="input-std">
                </div>
                <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold shadow-md cursor-pointer">Actualizar Retiro</button>
            </form>
        </div>
    </div>

    <!-- MODAL PARA EDITAR AJUSTE -->
    <div id="editAdjustmentModal" class="modal-overlay fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b flex justify-between items-center bg-green-50 rounded-t-2xl">
                <h2 class="text-xl font-bold text-green-700"><i class="fas fa-edit mr-2"></i> Editar Ajuste</h2>
                <button data-close="editAdjustmentModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button>
            </div>
            <form id="editAdjustmentForm" class="p-6 space-y-4">
                <input type="hidden" id="editAdjId">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="editAdjDate" class="input-std" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Monto (+/- $)</label>
                    <input type="number" id="editAdjAmount" step="0.01" class="input-std font-bold text-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Encargado</label>
                    <input type="text" id="editAdjEmployee" list="managerList" class="input-std" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Motivo</label>
                    <input type="text" id="editAdjNote" class="input-std" required>
                </div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-md cursor-pointer">Actualizar Ajuste</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        let firebaseConfig;
        if(typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = { 
                apiKey: "AIzaSyBIGUo2-YFCHKF6Nc8I-lB_NmGZiQ5pHJI",
                authDomain: "cryptotracker-8a6fd.firebaseapp.com",
                projectId: "cryptotracker-8a6fd",
                storageBucket: "cryptotracker-8a6fd.firebaseStorage.app",
                messagingSenderId: "720112375781",
                appId: "1:720112375781:web:7995dcbd6fe7470aea810c",
                measurementId: "G-2VW050K6PC"
            };
        }
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let userId = null;
        let products=[], sales=[], expenses=[], clients=[], withdrawals=[], news=[], adjustments=[]; // A√ëADIDO: adjustments
        let settings = { storeName: "MI NEGOCIO", employees: [], blockedCategories: {}, processedReports: [] };
        
        // Variables para gr√°fico
        let salesChart = null;
        let expensesChart = null;
        let profitChart = null;
        let inventoryChart = null;
        let paymentTypeChart = null; 
        let currentChartMode = 'daily'; 
        let currentFilteredSales = []; 
        let currentFilteredExpenses = [];
        let currentFilteredProfit = {sales: [], expenses: []};
        let currentFilteredInventory = [];

        // Variables Calculadora
        let calcType = 'surcharge'; 

        // Variable para notificaciones push
        let notificationPermission = false;
        let notificationServiceWorker = null;

        // Variables para ordenamiento
        let currentSortColumn = '';
        let currentSortDirection = 'asc'; // 'asc' o 'desc'
        let currentSortTable = ''; // 'sales', 'expenses', 'profit'

        // Variables para venta masiva
        let massiveSaleRows = [];
        let massiveSaleRowCounter = 0;

        // Variables para PIN
        let pinSettings = {
            pin: null,
            protectedSections: {
                salesHistory: false,
                profitHistory: false,
                grossProfit: false,
                cashReal: false,
                salesMonth: false,
                netProfit: false // NUEVO: Proteger Ganancia Neta
            }
        };

        // Variable para controlar estado de visualizaci√≥n de ganancia neta
        let netProfitVisible = false;

        // Variables para el juego
        let game = {
            canvas: null,
            ctx: null,
            player: {
                x: 300,
                y: 200,
                width: 40,
                height: 60,
                color: '#3b82f6',
                velocityX: 0,
                velocityY: 0,
                speed: 5,
                isJumping: false,
                jumpForce: 15,
                gravity: 0.8
            },
            coins: [],
            obstacles: [],
            particles: [],
            joystick: {
                x: 0,
                y: 0,
                isActive: false,
                maxDistance: 50
            },
            score: 0,
            health: 100,
            coinsCollected: 0,
            isRunning: false,
            lastTime: 0,
            keys: {}
        };

        const $ = id => document.getElementById(id);
        const fmtMoney = n => `$${parseFloat(n||0).toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}`;
        const fmtDate = s => { if(!s)return'-'; const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; };
        const getToday = () => new Date().toISOString().split('T')[0];
        window.openManager = (type) => openListManager(type);
        
        // TOAST FUNCTION
        function showToast(message, type = 'info', duration = 3000) {
            const container = $('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            container.appendChild(toast);

            // Mostrar
            setTimeout(() => toast.classList.add('show'), 10);

            // Ocultar y eliminar
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // FUNCIONES PARA EL JUEGO NIVEL 1 - MODO JOYSTICK
        function initGame() {
            game.canvas = $('gameCanvas');
            game.ctx = game.canvas.getContext('2d');
            
            // Configurar tama√±o del canvas
            game.canvas.width = game.canvas.offsetWidth;
            game.canvas.height = game.canvas.offsetHeight;
            
            // Inicializar jugador centrado
            game.player.x = game.canvas.width / 2 - game.player.width / 2;
            game.player.y = game.canvas.height / 2 - game.player.height / 2;
            
            // Generar monedas
            generateCoins(10);
            
            // Generar obst√°culos
            generateObstacles(5);
            
            // Iniciar bucle del juego
            game.isRunning = true;
            game.lastTime = performance.now();
            
            // Inicializar controles
            initGameControls();
            
            // Iniciar bucle de animaci√≥n
            requestAnimationFrame(gameLoop);
        }

        function generateCoins(count) {
            game.coins = [];
            for (let i = 0; i < count; i++) {
                game.coins.push({
                    x: Math.random() * (game.canvas.width - 30),
                    y: Math.random() * (game.canvas.height - 30),
                    width: 20,
                    height: 20,
                    color: '#fbbf24',
                    collected: false
                });
            }
        }

        function generateObstacles(count) {
            game.obstacles = [];
            for (let i = 0; i < count; i++) {
                game.obstacles.push({
                    x: Math.random() * (game.canvas.width - 60),
                    y: Math.random() * (game.canvas.height - 60),
                    width: 60,
                    height: 20,
                    color: '#ef4444'
                });
            }
        }

        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                game.particles.push({
                    x: x,
                    y: y,
                    velocityX: (Math.random() - 0.5) * 8,
                    velocityY: (Math.random() - 0.5) * 8,
                    size: Math.random() * 5 + 2,
                    color: color,
                    life: 1.0,
                    decay: 0.02
                });
            }
        }

        function updateParticles() {
            for (let i = game.particles.length - 1; i >= 0; i--) {
                const p = game.particles[i];
                p.x += p.velocityX;
                p.y += p.velocityY;
                p.life -= p.decay;
                
                if (p.life <= 0) {
                    game.particles.splice(i, 1);
                }
            }
        }

        function drawParticles() {
            game.particles.forEach(p => {
                game.ctx.globalAlpha = p.life;
                game.ctx.fillStyle = p.color;
                game.ctx.beginPath();
                game.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                game.ctx.fill();
            });
            game.ctx.globalAlpha = 1.0;
        }

        function initGameControls() {
            const joystickHandle = $('joystickHandle');
            const virtualJoystick = $('virtualJoystick');
            let isDragging = false;
            let startX, startY;
            let joystickRect;

            function updateJoystickPosition() {
                joystickRect = virtualJoystick.getBoundingClientRect();
                startX = joystickRect.left + joystickRect.width / 2;
                startY = joystickRect.top + joystickRect.height / 2;
            }

            // Actualizar posici√≥n inicial
            updateJoystickPosition();
            window.addEventListener('resize', updateJoystickPosition);

            // Eventos t√°ctiles
            joystickHandle.addEventListener('touchstart', handleStart);
            virtualJoystick.addEventListener('touchstart', handleStart);
            document.addEventListener('touchmove', handleMove);
            document.addEventListener('touchend', handleEnd);

            // Eventos de rat√≥n
            joystickHandle.addEventListener('mousedown', handleStart);
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);

            function handleStart(e) {
                e.preventDefault();
                isDragging = true;
                joystickHandle.classList.add('active');
                game.joystick.isActive = true;
                updateJoystickPosition();
            }

            function handleMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                let clientX, clientY;
                
                if (e.type.includes('touch')) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                const deltaX = clientX - startX;
                const deltaY = clientY - startY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const angle = Math.atan2(deltaY, deltaX);
                
                // Limitar distancia m√°xima
                const limitedDistance = Math.min(distance, game.joystick.maxDistance);
                
                // Calcular posici√≥n del joystick
                game.joystick.x = Math.cos(angle) * limitedDistance;
                game.joystick.y = Math.sin(angle) * limitedDistance;
                
                // Actualizar posici√≥n visual del joystick
                const joystickX = game.joystick.x;
                const joystickY = game.joystick.y;
                joystickHandle.style.transform = `translate(${joystickX}px, ${joystickY}px)`;
            }

            function handleEnd(e) {
                e.preventDefault();
                isDragging = false;
                joystickHandle.classList.remove('active');
                joystickHandle.style.transform = 'translate(0, 0)';
                game.joystick.isActive = false;
                game.joystick.x = 0;
                game.joystick.y = 0;
            }

            // Bot√≥n de salto
            $('jumpBtn').addEventListener('click', () => {
                if (!game.player.isJumping) {
                    game.player.velocityY = -game.player.jumpForce;
                    game.player.isJumping = true;
                    createParticles(
                        game.player.x + game.player.width / 2,
                        game.player.y + game.player.height,
                        10,
                        '#10b981'
                    );
                }
            });

            // Bot√≥n de acci√≥n
            $('actionBtn').addEventListener('click', () => {
                createParticles(
                    game.player.x + game.player.width / 2,
                    game.player.y + game.player.height / 2,
                    20,
                    '#ef4444'
                );
                // Efecto visual de acci√≥n
                game.player.color = '#f59e0b';
                setTimeout(() => {
                    game.player.color = '#3b82f6';
                }, 200);
            });

            // Bot√≥n de reinicio
            $('resetGameBtn').addEventListener('click', resetGame);
        }

        function updateGame(deltaTime) {
            // Aplicar movimiento del joystick al jugador
            if (game.joystick.isActive) {
                game.player.velocityX = game.joystick.x / 10;
                game.player.velocityY = game.joystick.y / 10;
            } else {
                // Frenado suave
                game.player.velocityX *= 0.9;
                game.player.velocityY *= 0.9;
            }
            
            // Aplicar gravedad
            game.player.velocityY += game.player.gravity;
            
            // Actualizar posici√≥n del jugador
            game.player.x += game.player.velocityX;
            game.player.y += game.player.velocityY;
            
            // Mantener jugador dentro de los l√≠mites
            game.player.x = Math.max(0, Math.min(game.canvas.width - game.player.width, game.player.x));
            game.player.y = Math.max(0, Math.min(game.canvas.height - game.player.height, game.player.y));
            
            // Detectar colisi√≥n con el suelo
            if (game.player.y >= game.canvas.height - game.player.height) {
                game.player.y = game.canvas.height - game.player.height;
                game.player.velocityY = 0;
                game.player.isJumping = false;
            }
            
            // Detectar colisi√≥n con obst√°culos
            game.obstacles.forEach(obstacle => {
                if (checkCollision(game.player, obstacle)) {
                    game.health -= 0.5;
                    createParticles(
                        game.player.x + game.player.width / 2,
                        game.player.y + game.player.height / 2,
                        8,
                        '#ef4444'
                    );
                }
            });
            
            // Detectar recolecci√≥n de monedas
            game.coins.forEach(coin => {
                if (!coin.collected && checkCollision(game.player, coin)) {
                    coin.collected = true;
                    game.coinsCollected++;
                    game.score += 100;
                    createParticles(
                        coin.x + coin.width / 2,
                        coin.y + coin.height / 2,
                        15,
                        '#fbbf24'
                    );
                    
                    // Actualizar UI
                    $('coinCount').textContent = game.coinsCollected;
                    $('scoreCount').textContent = game.score;
                }
            });
            
            // Actualizar part√≠culas
            updateParticles();
            
            // Actualizar salud
            $('healthCount').textContent = Math.max(0, Math.floor(game.health));
            
            // Verificar condici√≥n de derrota
            if (game.health <= 0) {
                gameOver();
            }
        }

        function drawGame() {
            // Limpiar canvas
            game.ctx.clearRect(0, 0, game.canvas.width, game.canvas.height);
            
            // Dibujar fondo
            const gradient = game.ctx.createLinearGradient(0, 0, 0, game.canvas.height);
            gradient.addColorStop(0, '#1e293b');
            gradient.addColorStop(1, '#0f172a');
            game.ctx.fillStyle = gradient;
            game.ctx.fillRect(0, 0, game.canvas.width, game.canvas.height);
            
            // Dibujar rejilla
            drawGrid();
            
            // Dibujar obst√°culos
            game.obstacles.forEach(obstacle => {
                game.ctx.fillStyle = obstacle.color;
                game.ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                
                // Efecto 3D
                game.ctx.fillStyle = '#dc2626';
                game.ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, 4);
                game.ctx.fillRect(obstacle.x, obstacle.y, 4, obstacle.height);
            });
            
            // Dibujar monedas
            game.coins.forEach(coin => {
                if (!coin.collected) {
                    // Efecto de rotaci√≥n
                    const time = Date.now() * 0.002;
                    const scale = 1 + Math.sin(time) * 0.1;
                    
                    game.ctx.save();
                    game.ctx.translate(coin.x + coin.width / 2, coin.y + coin.height / 2);
                    game.ctx.scale(scale, scale);
                    
                    // Dibujar moneda
                    const coinGradient = game.ctx.createRadialGradient(0, 0, 2, 0, 0, 10);
                    coinGradient.addColorStop(0, '#fde047');
                    coinGradient.addColorStop(1, '#d97706');
                    game.ctx.fillStyle = coinGradient;
                    game.ctx.beginPath();
                    game.ctx.arc(0, 0, 10, 0, Math.PI * 2);
                    game.ctx.fill();
                    
                    // Detalle interior
                    game.ctx.fillStyle = '#fbbf24';
                    game.ctx.beginPath();
                    game.ctx.arc(0, 0, 6, 0, Math.PI * 2);
                    game.ctx.fill();
                    
                    game.ctx.restore();
                }
            });
            
            // Dibujar part√≠culas
            drawParticles();
            
            // Dibujar jugador
            drawPlayer();
            
            // Dibujar indicador de joystick activo
            if (game.joystick.isActive) {
                drawJoystickIndicator();
            }
        }

        function drawGrid() {
            game.ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            game.ctx.lineWidth = 1;
            
            // L√≠neas verticales
            for (let x = 0; x < game.canvas.width; x += 50) {
                game.ctx.beginPath();
                game.ctx.moveTo(x, 0);
                game.ctx.lineTo(x, game.canvas.height);
                game.ctx.stroke();
            }
            
            // L√≠neas horizontales
            for (let y = 0; y < game.canvas.height; y += 50) {
                game.ctx.beginPath();
                game.ctx.moveTo(0, y);
                game.ctx.lineTo(game.canvas.width, y);
                game.ctx.stroke();
            }
        }

        function drawPlayer() {
            // Sombra
            game.ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            game.ctx.beginPath();
            game.ctx.ellipse(
                game.player.x + game.player.width / 2,
                game.player.y + game.player.height + 5,
                game.player.width / 2,
                8,
                0, 0, Math.PI * 2
            );
            game.ctx.fill();
            
            // Cuerpo del jugador
            const playerGradient = game.ctx.createLinearGradient(
                game.player.x, game.player.y,
                game.player.x, game.player.y + game.player.height
            );
            playerGradient.addColorStop(0, game.player.color);
            playerGradient.addColorStop(1, '#1d4ed8');
            
            game.ctx.fillStyle = playerGradient;
            game.ctx.fillRect(game.player.x, game.player.y, game.player.width, game.player.height);
            
            // Detalles del jugador
            game.ctx.fillStyle = '#1e40af';
            game.ctx.fillRect(game.player.x + 5, game.player.y + 10, game.player.width - 10, 15);
            
            // Ojos
            game.ctx.fillStyle = 'white';
            game.ctx.fillRect(game.player.x + 10, game.player.y + 15, 6, 6);
            game.ctx.fillRect(game.player.x + game.player.width - 16, game.player.y + 15, 6, 6);
            
            game.ctx.fillStyle = '#0f172a';
            game.ctx.fillRect(game.player.x + 12, game.player.y + 17, 2, 2);
            game.ctx.fillRect(game.player.x + game.player.width - 14, game.player.y + 17, 2, 2);
            
            // Indicador de salud
            const healthWidth = (game.health / 100) * (game.player.width - 10);
            game.ctx.fillStyle = '#ef4444';
            game.ctx.fillRect(game.player.x + 5, game.player.y - 10, game.player.width - 10, 4);
            
            game.ctx.fillStyle = '#10b981';
            game.ctx.fillRect(game.player.x + 5, game.player.y - 10, healthWidth, 4);
        }

        function drawJoystickIndicator() {
            const centerX = game.canvas.width - 100;
            const centerY = game.canvas.height - 100;
            const radius = 30;
            
            // C√≠rculo base
            game.ctx.fillStyle = 'rgba(59, 130, 246, 0.2)';
            game.ctx.beginPath();
            game.ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            game.ctx.fill();
            
            // Indicador de direcci√≥n
            const angle = Math.atan2(game.joystick.y, game.joystick.x);
            const distance = Math.sqrt(game.joystick.x * game.joystick.x + game.joystick.y * game.joystick.y);
            const normalizedDistance = Math.min(distance / game.joystick.maxDistance, 1);
            
            const indicatorX = centerX + Math.cos(angle) * radius * normalizedDistance;
            const indicatorY = centerY + Math.sin(angle) * radius * normalizedDistance;
            
            game.ctx.fillStyle = 'rgba(59, 130, 246, 0.8)';
            game.ctx.beginPath();
            game.ctx.arc(indicatorX, indicatorY, 12, 0, Math.PI * 2);
            game.ctx.fill();
            
            // Flecha de direcci√≥n
            game.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            game.ctx.lineWidth = 2;
            game.ctx.beginPath();
            game.ctx.moveTo(centerX, centerY);
            game.ctx.lineTo(indicatorX, indicatorY);
            game.ctx.stroke();
        }

        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        function gameLoop(currentTime) {
            if (!game.isRunning) return;
            
            const deltaTime = (currentTime - game.lastTime) / 16.67; // Normalizar a ~60fps
            game.lastTime = currentTime;
            
            updateGame(deltaTime);
            drawGame();
            
            requestAnimationFrame(gameLoop);
        }

        function resetGame() {
            game.score = 0;
            game.health = 100;
            game.coinsCollected = 0;
            
            game.player.x = game.canvas.width / 2 - game.player.width / 2;
            game.player.y = game.canvas.height / 2 - game.player.height / 2;
            game.player.velocityX = 0;
            game.player.velocityY = 0;
            game.player.isJumping = false;
            
            game.particles = [];
            generateCoins(10);
            generateObstacles(5);
            
            // Actualizar UI
            $('coinCount').textContent = game.coinsCollected;
            $('scoreCount').textContent = game.score;
            $('healthCount').textContent = game.health;
            
            showToast("¬°Juego reiniciado!", 'info');
        }

        function gameOver() {
            game.isRunning = false;
            
            // Mostrar mensaje de fin del juego
            game.ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            game.ctx.fillRect(0, 0, game.canvas.width, game.canvas.height);
            
            game.ctx.fillStyle = 'white';
            game.ctx.font = 'bold 48px Inter';
            game.ctx.textAlign = 'center';
            game.ctx.fillText('¬°GAME OVER!', game.canvas.width / 2, game.canvas.height / 2 - 50);
            
            game.ctx.font = '24px Inter';
            game.ctx.fillText(`Puntuaci√≥n: ${game.score}`, game.canvas.width / 2, game.canvas.height / 2);
            game.ctx.fillText(`Monedas: ${game.coinsCollected}`, game.canvas.width / 2, game.canvas.height / 2 + 40);
            
            game.ctx.fillStyle = '#3b82f6';
            game.ctx.font = '20px Inter';
            game.ctx.fillText('Toca "Reiniciar" para jugar otra vez', game.canvas.width / 2, game.canvas.height / 2 + 100);
            
            showToast(`¬°Juego terminado! Puntuaci√≥n: ${game.score}`, 'error');
        }

        // FUNCIONES PARA MANEJO DE PIN
        function updatePinDots(inputId, dotPrefix) {
            const input = $(inputId);
            const value = input.value;
            
            for (let i = 1; i <= 4; i++) {
                const dot = $(`${dotPrefix}${i}`);
                if (dot) {
                    if (value.length >= i) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                }
            }
        }

        async function loadPinSettings() {
            try {
                const pinDoc = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'pin'));
                if (pinDoc.exists()) {
                    pinSettings = pinDoc.data();
                    applyPinProtection();
                    updateNetProfitVisibility();
                }
            } catch (error) {
                console.error("Error cargando configuraci√≥n de PIN:", error);
            }
        }

        async function savePinSettings() {
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'pin'), pinSettings);
                applyPinProtection();
                updateNetProfitVisibility();
                showToast("Configuraci√≥n de PIN guardada", 'success');
            } catch (error) {
                console.error("Error guardando configuraci√≥n de PIN:", error);
                showToast("Error al guardar configuraci√≥n de PIN", 'error');
            }
        }

        function applyPinProtection() {
            // Aplicar protecci√≥n a secciones
            document.querySelectorAll('.protected-section').forEach(section => {
                const protectedId = section.dataset.protected;
                if (protectedId && pinSettings.protectedSections[protectedId]) {
                    section.classList.add('locked');
                    
                    // A√±adir overlay de PIN si no existe (excepto para netProfit que usa asteriscos)
                    if (!section.querySelector('.protected-overlay') && protectedId !== 'netProfit') {
                        const overlay = document.createElement('div');
                        overlay.className = 'protected-overlay';
                        overlay.innerHTML = `
                            <i class="fas fa-lock text-2xl text-purple-600 mb-2"></i>
                            <p class="text-sm font-bold mb-2">Protegido con PIN</p>
                            <button class="bg-purple-600 text-white px-4 py-1 rounded-lg text-sm hover:bg-purple-700 transition" onclick="requestPinAccess('${protectedId}')">
                                Ingresar PIN
                            </button>
                        `;
                        section.style.position = 'relative';
                        section.appendChild(overlay);
                    }
                } else {
                    section.classList.remove('locked');
                    const overlay = section.querySelector('.protected-overlay');
                    if (overlay) overlay.remove();
                }
            });
        }

        // FUNCI√ìN PARA ACTUALIZAR VISIBILIDAD DE GANANCIA NETA
        function updateNetProfitVisibility() {
            const hiddenElement = $('cardGananciaMesHidden');
            const visibleElement = $('cardGananciaMes');
            const toggleBtn = $('toggleNetProfitBtn');
            const lockedIndicator = $('netProfitLocked');
            const unlockedIndicator = $('netProfitUnlocked');
            
            if (!hiddenElement || !visibleElement) return;
            
            const isProtected = pinSettings.protectedSections.netProfit && pinSettings.pin;
            
            if (isProtected) {
                // Si est√° protegido, mostrar asteriscos u ocultar seg√∫n estado
                if (netProfitVisible) {
                    hiddenElement.classList.add('hidden');
                    visibleElement.classList.remove('hidden');
                    hiddenElement.classList.remove('hidden-value');
                    if (toggleBtn) {
                        toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                        toggleBtn.title = "Ocultar valor";
                    }
                    if (lockedIndicator) lockedIndicator.classList.add('hidden');
                    if (unlockedIndicator) unlockedIndicator.classList.remove('hidden');
                } else {
                    hiddenElement.classList.remove('hidden');
                    visibleElement.classList.add('hidden');
                    hiddenElement.classList.add('hidden-value');
                    if (toggleBtn) {
                        toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
                        toggleBtn.title = "Mostrar valor (requiere PIN)";
                    }
                    if (lockedIndicator) lockedIndicator.classList.remove('hidden');
                    if (unlockedIndicator) unlockedIndicator.classList.add('hidden');
                }
            } else {
                // Si no est√° protegido, siempre mostrar valor
                hiddenElement.classList.add('hidden');
                visibleElement.classList.remove('hidden');
                hiddenElement.classList.remove('hidden-value');
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    toggleBtn.title = "Mostrar/ocultar valor";
                }
                if (lockedIndicator) lockedIndicator.classList.add('hidden');
                if (unlockedIndicator) unlockedIndicator.classList.add('hidden');
            }
        }

        // FUNCI√ìN PARA TOGGLE DE VISIBILIDAD DE GANANCIA NETA
        window.toggleNetProfitVisibility = function() {
            const isProtected = pinSettings.protectedSections.netProfit && pinSettings.pin;
            
            if (isProtected) {
                if (!netProfitVisible) {
                    // Solicitar PIN para mostrar
                    window.requestedSection = 'netProfit';
                    $('pinVerifyModal').classList.remove('hidden');
                    $('pinVerifyInput').value = '';
                    $('pinVerifyInput').focus();
                    updatePinDots('pinVerifyInput', 'verifyPinDot');
                    $('pinError').classList.add('hidden');
                    return;
                }
            }
            
            // Cambiar visibilidad
            netProfitVisible = !netProfitVisible;
            updateNetProfitVisibility();
        };

        function requestPinAccess(sectionId) {
            // Guardar la secci√≥n que se quiere acceder
            window.requestedSection = sectionId;
            $('pinVerifyModal').classList.remove('hidden');
            $('pinVerifyInput').value = '';
            $('pinVerifyInput').focus();
            updatePinDots('pinVerifyInput', 'verifyPinDot');
            $('pinError').classList.add('hidden');
        }

        function verifyPin(inputPin) {
            return inputPin === pinSettings.pin;
        }

        function grantAccess(sectionId) {
            if (sectionId === 'netProfit') {
                // Para ganancia neta, simplemente mostrar el valor
                netProfitVisible = true;
                updateNetProfitVisibility();
            } else {
                // Para otras secciones, proceder como antes
                const section = document.querySelector(`[data-protected="${sectionId}"]`);
                if (section) {
                    section.classList.remove('locked');
                    const overlay = section.querySelector('.protected-overlay');
                    if (overlay) overlay.remove();
                    
                    // Ejecutar la acci√≥n correspondiente
                    switch(sectionId) {
                        case 'salesHistory':
                            renderSalesList();
                            $('salesHistoryModal').classList.remove('hidden');
                            break;
                        case 'profitHistory':
                            renderProfitReport();
                            $('gananciasDetailModal').classList.remove('hidden');
                            break;
                        case 'grossProfit':
                        case 'cashReal':
                            // Estas secciones est√°n dentro del modal de caja
                            break;
                        case 'salesMonth':
                            // Solo mostrar la tarjeta
                            break;
                    }
                }
            }
        }

        // FUNCI√ìN PARA CARGAR DETALLES DIARIOS
        window.loadDailyDetails = function() {
            const date = $('dailyDetailsDate').value || getToday();
            
            // Filtrar ventas del d√≠a
            const dailySales = sales.filter(s => s.date === date);
            const dailyExpenses = expenses.filter(e => e.date === date);
            
            // Calcular totales
            const totalSales = dailySales.reduce((sum, s) => sum + (parseFloat(s.montoCobrado) || 0), 0);
            const totalExpenses = dailyExpenses.reduce((sum, e) => sum + (parseFloat(e.gastoTotal) || 0), 0);
            const netProfit = totalSales - totalExpenses;
            
            // Actualizar resumen
            $('dailyTotalSales').textContent = fmtMoney(totalSales);
            $('dailyTotalExpenses').textContent = fmtMoney(totalExpenses);
            $('dailyNetProfit').textContent = fmtMoney(netProfit);
            
            // Agrupar ventas por m√©todo de pago
            const salesByPayment = {};
            dailySales.forEach(s => {
                const paymentType = s.paymentType || 'Sin Pago';
                const amount = parseFloat(s.montoCobrado) || 0;
                salesByPayment[paymentType] = (salesByPayment[paymentType] || 0) + amount;
            });
            
            // Mostrar ventas por m√©todo de pago
            const salesByPaymentContainer = $('dailySalesByPayment');
            salesByPaymentContainer.innerHTML = '';
            
            Object.entries(salesByPayment).forEach(([paymentType, amount]) => {
                let badgeClass = 'payment-method-otro';
                const lowerPayment = paymentType.toLowerCase();
                
                if (lowerPayment.includes('efectivo')) badgeClass = 'payment-method-efectivo';
                else if (lowerPayment.includes('tarjeta')) badgeClass = 'payment-method-tarjeta';
                else if (lowerPayment.includes('transferencia')) badgeClass = 'payment-method-transferencia';
                else if (lowerPayment.includes('qr')) badgeClass = 'payment-method-qr';
                else if (lowerPayment.includes('nave')) badgeClass = 'payment-method-nave';
                
                const div = document.createElement('div');
                div.className = 'daily-detail-row';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="payment-method-badge ${badgeClass}">${paymentType}</span>
                        </div>
                        <div class="font-bold text-blue-600">${fmtMoney(amount)}</div>
                    </div>
                `;
                salesByPaymentContainer.appendChild(div);
            });
            
            // Mostrar detalle de ventas
            const salesDetailContainer = $('dailySalesDetail');
            salesDetailContainer.innerHTML = '';
            
            if (dailySales.length === 0) {
                salesDetailContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No hay ventas registradas para este d√≠a.</p>';
            } else {
                dailySales.forEach(sale => {
                    const div = document.createElement('div');
                    div.className = 'daily-detail-row';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-bold">${sale.clientName || 'Cliente no registrado'}</div>
                                <div class="text-xs text-gray-500">${sale.employee || 'Sin encargado'} ‚Ä¢ ${sale.time || ''}</div>
                                <div class="text-sm mt-1">${sale.productName || ''} ${sale.quantitySold ? `(${sale.quantitySold} unidades)` : ''}</div>
                                ${sale.notes ? `<div class="text-xs text-blue-500 mt-1"><i class="fas fa-sticky-note mr-1"></i>${sale.notes}</div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-green-600">${fmtMoney(sale.montoCobrado || 0)}</div>
                                <div class="text-xs text-gray-500">${sale.paymentType || ''}</div>
                            </div>
                        </div>
                    `;
                    salesDetailContainer.appendChild(div);
                });
            }
            
            // Mostrar detalle de gastos
            const expensesDetailContainer = $('dailyExpensesDetail');
            expensesDetailContainer.innerHTML = '';
            
            if (dailyExpenses.length === 0) {
                expensesDetailContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No hay gastos registrados para este d√≠a.</p>';
            } else {
                dailyExpenses.forEach(expense => {
                    const div = document.createElement('div');
                    div.className = 'daily-detail-row';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-bold">${expense.category || 'Sin categor√≠a'}</div>
                                <div class="text-xs text-gray-500">${expense.manager || 'Sin encargado'}</div>
                                <div class="text-sm mt-1">${expense.description || ''}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-red-600">${fmtMoney(expense.gastoTotal || 0)}</div>
                                <div class="text-xs text-gray-500">${expense.paymentMethod || ''}</div>
                            </div>
                        </div>
                    `;
                    expensesDetailContainer.appendChild(div);
                });
            }
        };

        // FUNCI√ìN PARA NOTIFICACIONES PUSH - ACTUALIZADA CON FCM
        async function initializeNotifications() {
            if ('Notification' in window) {
                notificationPermission = Notification.permission === 'granted';
                
                const notificationBtn = $('notificationToggleBtn');
                if (notificationBtn) {
                    if (notificationPermission) {
                        notificationBtn.classList.add('active');
                        notificationBtn.querySelector('i').classList.remove('fa-bell-slash');
                        notificationBtn.querySelector('i').classList.add('fa-bell');
                        notificationBtn.title = "Notificaciones activadas";
                        localStorage.setItem('notificationsEnabled', 'true');
                        
                        // Inicializar FCM
                        try {
                            await initializeFCM();
                        } catch (error) {
                            console.error('Error inicializando FCM:', error);
                        }
                    } else {
                        notificationBtn.classList.remove('active');
                        notificationBtn.querySelector('i').classList.remove('fa-bell');
                        notificationBtn.querySelector('i').classList.add('fa-bell-slash');
                        notificationBtn.title = "Activar notificaciones";
                        localStorage.setItem('notificationsEnabled', 'false');
                    }
                }
            }
        }

        async function toggleNotifications() {
            if (!('Notification' in window)) {
                showToast('Tu navegador no soporta notificaciones', 'error');
                return;
            }

            if (Notification.permission === 'denied') {
                showToast('Permiso de notificaciones denegado. Por favor habil√≠talo manualmente en configuraci√≥n.', 'error');
                return;
            }

            const notificationBtn = $('notificationToggleBtn');
            
            if (Notification.permission === 'default' || !notificationPermission) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    notificationPermission = true;
                    await initializeNotifications();
                    showToast('Notificaciones activadas. Recibir√°s alertas importantes.', 'success');
                    
                    // Configurar FCM
                    await initializeFCM();
                } else {
                    showToast('Notificaciones desactivadas', 'info');
                }
            } else {
                // Desactivar notificaciones
                notificationPermission = false;
                
                // Desuscribirse de FCM
                await unsubscribeFromFCM();
                
                if (notificationBtn) {
                    notificationBtn.classList.remove('active');
                    notificationBtn.querySelector('i').classList.remove('fa-bell');
                    notificationBtn.querySelector('i').classList.add('fa-bell-slash');
                    notificationBtn.title = "Activar notificaciones";
                }
                localStorage.setItem('notificationsEnabled', 'false');
                showToast('Notificaciones desactivadas', 'info');
            }
        }

        // Funci√≥n para enviar notificaci√≥n push a todos los usuarios
        function sendNotificationToAll(title, body, tag = 'business-notification') {
            // Enviar a trav√©s de Firestore para que todos los usuarios lo reciban
            try {
                // Guardar la notificaci√≥n en una colecci√≥n global
                addDoc(collection(db, 'artifacts', appId, 'globalNotifications'), {
                    title: title,
                    body: body,
                    timestamp: new Date().toISOString(),
                    type: 'system'
                }).then(() => {
                    console.log('Notificaci√≥n enviada a todos los usuarios');
                });
            } catch (error) {
                console.error('Error enviando notificaci√≥n global:', error);
            }
            
            // Tambi√©n enviar notificaci√≥n local si las notificaciones est√°n activadas
            if (!notificationPermission || !('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }

            if (notificationServiceWorker) {
                notificationServiceWorker.showNotification(title, {
                    body: body,
                    icon: '/icon-192.png',
                    badge: '/icon-72.png',
                    tag: tag,
                    requireInteraction: true
                });
            } else if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '/icon-192.png',
                    badge: '/icon-72.png',
                    tag: tag
                });
            }
        }

        // Escuchar notificaciones globales
        function listenToGlobalNotifications() {
            const globalNotificationsRef = collection(db, 'artifacts', appId, 'globalNotifications');
            
            onSnapshot(query(globalNotificationsRef, where("timestamp", ">", new Date(Date.now() - 60000).toISOString())), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        // Mostrar notificaci√≥n local
                        if (notificationPermission) {
                            if (notificationServiceWorker) {
                                notificationServiceWorker.showNotification(data.title, {
                                    body: data.body,
                                    icon: '/icon-192.png',
                                    badge: '/icon-72.png'
                                });
                            } else if ('Notification' in window && Notification.permission === 'granted') {
                                new Notification(data.title, {
                                    body: data.body,
                                    icon: '/icon-192.png',
                                    badge: '/icon-72.png'
                                });
                            }
                        }
                        // Mostrar toast
                        showToast(`${data.title}: ${data.body}`, 'info', 5000);
                    }
                });
            });
        }

        // FUNCI√ìN PARA CAMBIAR TIPO DE VENTA
        window.switchSaleType = (type) => {
            const unitForm = $('saleForm');
            const massiveForm = $('massiveSaleForm');
            const slider = $('saleTypeSlider');
            const unitOption = document.querySelector('.sale-type-option[data-type="single"]');
            const massiveOption = document.querySelector('.sale-type-option[data-type="massive"]');
            
            if (type === 'single') {
                unitForm.style.display = 'block';
                massiveForm.style.display = 'none';
                slider.style.transform = 'translateX(0)';
                unitOption.classList.add('active');
                massiveOption.classList.remove('active');
            } else {
                unitForm.style.display = 'none';
                massiveForm.style.display = 'block';
                slider.style.transform = 'translateX(100%)';
                massiveOption.classList.add('active');
                unitOption.classList.remove('active');
                
                // Inicializar la tabla masiva si est√° vac√≠a
                if (massiveSaleRows.length === 0) {
                    addMassiveSaleRow();
                }
                updateMassiveSalesTotal();
            }
        };

        // FUNCI√ìN PARA AGREGAR FILA A VENTA MASIVA
        window.addMassiveSaleRow = () => {
            massiveSaleRowCounter++;
            const rowId = `massive-row-${massiveSaleRowCounter}`;
            
            // Ocultar fila vac√≠a si existe
            const emptyRow = $('massiveSaleEmptyRow');
            if (emptyRow) {
                emptyRow.style.display = 'none';
            }
            
            const productOptions = products.map(p => 
                `<option value="${p.id}">${p.name} (${p.prodType || 'Sin tipo'}) - Stock: ${p.stock || 0}</option>`
            ).join('');
            
            const rowHTML = `
                <tr id="${rowId}" class="massive-sale-row">
                    <td class="px-4 py-2">
                        <select class="massive-sale-input massive-product" data-row="${rowId}" onchange="updateProductInfo('${rowId}')">
                            <option value="">Seleccionar producto</option>
                            ${productOptions}
                        </select>
                        <div class="text-xs text-gray-500 mt-1 product-type-display" id="product-type-${rowId}"></div>
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" class="massive-sale-input massive-shift" data-row="${rowId}" readonly placeholder="Autom√°tico">
                    </td>
                    <td class="px-4 py-2">
                        <input type="time" class="massive-sale-input massive-time" data-row="${rowId}" onchange="updateShift('${rowId}')" value="${new Date().toLocaleTimeString('es-ES', {hour12: false, hour: '2-digit', minute: '2-digit'})}">
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" class="massive-sale-input massive-employee" data-row="${rowId}" list="managerList">
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" step="0.01" class="massive-sale-input massive-amount" data-row="${rowId}" oninput="updateMassiveSalesTotal()" placeholder="0.00">
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" class="massive-sale-input massive-quantity" data-row="${rowId}" min="1" value="1" oninput="updateMassiveSalesTotal()">
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" class="massive-sale-input massive-payment" data-row="${rowId}" list="paymentList">
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" class="massive-sale-input massive-channel" data-row="${rowId}" list="channelList">
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" class="massive-sale-input massive-client" data-row="${rowId}" list="clientList">
                    </td>
                    <td class="px-4 py-2">
                        <input type="tel" class="massive-sale-input massive-whatsapp" data-row="${rowId}" placeholder="WhatsApp">
                    </td>
                    <td class="px-4 py-2">
                        <input type="email" class="massive-sale-input massive-email" data-row="${rowId}" placeholder="Email">
                    </td>
                    <td class="px-4 py-2">
                        <textarea class="massive-sale-input massive-notes" data-row="${rowId}" rows="1" placeholder="Nota"></textarea>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <button type="button" onclick="removeMassiveSaleRow('${rowId}')" class="delete-row-btn" title="Eliminar fila">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            const tbody = $('massiveSaleTableBody');
            if (tbody.querySelector('#massiveSaleEmptyRow')) {
                tbody.innerHTML = rowHTML;
            } else {
                tbody.insertAdjacentHTML('beforeend', rowHTML);
            }
            
            massiveSaleRows.push(rowId);
            
            // Actualizar turno autom√°ticamente
            updateShift(rowId);
            
            // Si hay un encargado predeterminado, aplicarlo
            const defaultEmployee = $('massiveSaleEmployee').value;
            if (defaultEmployee) {
                const employeeInput = document.querySelector(`#${rowId} .massive-employee`);
                if (employeeInput) employeeInput.value = defaultEmployee;
            }
            
            // Actualizar total
            updateMassiveSalesTotal();
        };

        // FUNCI√ìN PARA ACTUALIZAR INFORMACI√ìN DEL PRODUCTO
        window.updateProductInfo = (rowId) => {
            const select = document.querySelector(`#${rowId} .massive-product`);
            const productId = select.value;
            const product = products.find(p => p.id === productId);
            const typeDisplay = document.querySelector(`#product-type-${rowId}`);
            
            if (product && typeDisplay) {
                typeDisplay.textContent = `Tipo: ${product.prodType || 'Sin tipo'}`;
            } else if (typeDisplay) {
                typeDisplay.textContent = '';
            }
        };

        // FUNCI√ìN PARA ACTUALIZAR TURNO
        window.updateShift = (rowId) => {
            const timeInput = document.querySelector(`#${rowId} .massive-time`);
            const shiftInput = document.querySelector(`#${rowId} .massive-shift`);
            
            if (timeInput && shiftInput) {
                const timeStr = timeInput.value;
                const [h, m] = timeStr.split(':').map(Number);
                const floatTime = h + m/60;
                
                if (floatTime >= 10 && floatTime < 16) {
                    shiftInput.value = 'Turno Ma√±ana';
                } else if (floatTime >= 16 && floatTime <= 21) {
                    shiftInput.value = 'Turno Tarde';
                } else {
                    shiftInput.value = 'Fuera de Horario';
                }
            }
        };

        // FUNCI√ìN PARA ELIMINAR FILA DE VENTA MASIVA
        window.removeMassiveSaleRow = (rowId) => {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                massiveSaleRows = massiveSaleRows.filter(id => id !== rowId);
                
                // Mostrar fila vac√≠a si no hay filas
                if (massiveSaleRows.length === 0) {
                    const emptyRow = $('massiveSaleEmptyRow');
                    if (emptyRow) {
                        emptyRow.style.display = '';
                    }
                }
                
                updateMassiveSalesTotal();
            }
        };

        // FUNCI√ìN PARA ACTUALIZAR TOTAL DE VENTAS MASIVAS
        window.updateMassiveSalesTotal = () => {
            let total = 0;
            let count = 0;
            
            massiveSaleRows.forEach(rowId => {
                const amountInput = document.querySelector(`#${rowId} .massive-amount`);
                const quantityInput = document.querySelector(`#${rowId} .massive-quantity`);
                
                if (amountInput && amountInput.value) {
                    const amount = parseFloat(amountInput.value) || 0;
                    const quantity = parseInt(quantityInput?.value) || 1;
                    total += amount * quantity;
                    count++;
                }
            });
            
            $('massiveSalesTotal').textContent = fmtMoney(total);
            $('massiveSalesCount').textContent = count;
        };

        // FUNCI√ìN PARA ORDENAR TABLAS
        window.sortTable = (tableType, column) => {
            // Si se hace clic en la misma columna, invertir direcci√≥n
            if (currentSortTable === tableType && currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
                currentSortTable = tableType;
            }
            
            // Actualizar flechas de ordenamiento
            updateSortArrows(tableType, column);
            
            // Ordenar la tabla correspondiente
            if (tableType === 'sales') {
                sortSalesTable(column, currentSortDirection);
            } else if (tableType === 'expenses') {
                sortExpensesTable(column, currentSortDirection);
            } else if (tableType === 'profit') {
                sortProfitTable(column, currentSortDirection);
            }
        };

        // FUNCI√ìN PARA ACTUALIZAR FLECHAS DE ORDENAMIENTO
        function updateSortArrows(tableType, column) {
            // Resetear todas las flechas
            document.querySelectorAll('.sort-arrow').forEach(arrow => {
                arrow.textContent = '‚Üï';
                arrow.style.opacity = '0.6';
            });
            
            // Establecer flecha para la columna actual
            const arrowId = `${tableType}Sort${capitalizeFirstLetter(column)}`;
            const arrow = $(arrowId);
            if (arrow) {
                arrow.textContent = currentSortDirection === 'asc' ? '‚Üë' : '‚Üì';
                arrow.style.opacity = '1';
            }
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // FUNCI√ìN PARA ORDENAR TABLA DE VENTAS
        function sortSalesTable(column, direction) {
            const tbody = $('salesTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                let aValue, bValue;
                
                switch (column) {
                    case 'date':
                        const aDate = a.cells[0].querySelector('.font-bold')?.textContent || '';
                        const bDate = b.cells[0].querySelector('.font-bold')?.textContent || '';
                        aValue = aDate.split('/').reverse().join('');
                        bValue = bDate.split('/').reverse().join('');
                        break;
                        
                    case 'client':
                        aValue = a.cells[1].textContent.trim();
                        bValue = b.cells[1].textContent.trim();
                        break;
                        
                    case 'product':
                        aValue = a.cells[2].textContent.trim();
                        bValue = b.cells[2].textContent.trim();
                        break;
                        
                    case 'quantity':
                        aValue = parseInt(a.cells[3].textContent.trim()) || 0;
                        bValue = parseInt(b.cells[3].textContent.trim()) || 0;
                        break;
                        
                    case 'payment':
                        aValue = a.cells[4].textContent.trim();
                        bValue = b.cells[4].textContent.trim();
                        break;
                        
                    case 'employee':
                        aValue = a.cells[5].textContent.trim();
                        bValue = b.cells[5].textContent.trim();
                        break;
                        
                    case 'amount':
                        const aAmountText = a.cells[6].textContent.replace('$', '').replace('.', '').replace(',', '.');
                        const bAmountText = b.cells[6].textContent.replace('$', '').replace('.', '').replace(',', '.');
                        aValue = parseFloat(aAmountText) || 0;
                        bValue = parseFloat(bAmountText) || 0;
                        break;
                        
                    default:
                        return 0;
                }
                
                // Comparar seg√∫n el tipo de dato
                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    return direction === 'asc' 
                        ? aValue.localeCompare(bValue, 'es', { sensitivity: 'base' })
                        : bValue.localeCompare(aValue, 'es', { sensitivity: 'base' });
                } else {
                    return direction === 'asc' ? aValue - bValue : bValue - aValue;
                }
            });
            
            // Reordenar filas en la tabla
            rows.forEach(row => tbody.appendChild(row));
        }

        // FUNCI√ìN PARA ORDENAR TABLA DE GASTOS
        function sortExpensesTable(column, direction) {
            const tbody = $('expensesTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                let aValue, bValue;
                
                switch (column) {
                    case 'date':
                        aValue = a.cells[0].textContent.trim();
                        bValue = b.cells[0].textContent.trim();
                        const aDate = aValue.split('/').reverse().join('');
                        const bDate = bValue.split('/').reverse().join('');
                        return direction === 'asc' ? aDate.localeCompare(bDate) : bDate.localeCompare(aDate);
                        
                    case 'category':
                        aValue = a.cells[1].textContent.trim();
                        bValue = b.cells[1].textContent.trim();
                        break;
                        
                    case 'payment':
                        aValue = a.cells[2].textContent.trim();
                        bValue = b.cells[2].textContent.trim();
                        break;
                        
                    case 'manager':
                        aValue = a.cells[3].textContent.trim();
                        bValue = b.cells[3].textContent.trim();
                        break;
                        
                    case 'amount':
                        const aAmountText = a.cells[4].textContent.replace('-$', '').replace('$', '').replace('.', '').replace(',', '.');
                        const bAmountText = b.cells[4].textContent.replace('-$', '').replace('$', '').replace('.', '').replace(',', '.');
                        aValue = parseFloat(aAmountText) || 0;
                        bValue = parseFloat(bAmountText) || 0;
                        break;
                        
                    default:
                        return 0;
                }
                
                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    return direction === 'asc' 
                        ? aValue.localeCompare(bValue, 'es', { sensitivity: 'base' })
                        : bValue.localeCompare(aValue, 'es', { sensitivity: 'base' });
                } else {
                    return direction === 'asc' ? aValue - bValue : bValue - aValue;
                }
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        // FUNCI√ìN PARA ORDENAR TABLA DE RENTABILIDAD
        function sortProfitTable(column, direction) {
            const tbody = $('profitTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                let aValue, bValue;
                
                switch (column) {
                    case 'date':
                        aValue = a.cells[0].textContent.trim();
                        bValue = b.cells[0].textContent.trim();
                        const aDate = aValue.split('/').reverse().join('');
                        const bDate = bValue.split('/').reverse().join('');
                        return direction === 'asc' ? aDate.localeCompare(bDate) : bDate.localeCompare(aDate);
                        
                    case 'sales':
                        const aSalesText = a.cells[1].textContent.replace('$', '').replace('.', '').replace(',', '.');
                        const bSalesText = b.cells[2].textContent.replace('$', '').replace('.', '').replace(',', '.');
                        aValue = parseFloat(aSalesText) || 0;
                        bValue = parseFloat(bSalesText) || 0;
                        break;
                        
                    case 'expenses':
                        const aExpensesText = a.cells[2].textContent.replace('$', '').replace('.', '').replace(',', '.');
                        const bExpensesText = b.cells[3].textContent.replace('$', '').replace('.', '').replace(',', '.');
                        aValue = parseFloat(aExpensesText) || 0;
                        bValue = parseFloat(bExpensesText) || 0;
                        break;
                        
                    case 'balance':
                        const aBalanceText = a.cells[3].textContent.replace('$', '').replace('.', '').replace(',', '.');
                        const bBalanceText = b.cells[4].textContent.replace('$', '').replace('.', '').replace(',', '.');
                        aValue = parseFloat(aBalanceText) || 0;
                        bValue = parseFloat(bBalanceText) || 0;
                        break;
                        
                    default:
                        return 0;
                }
                
                return direction === 'asc' ? aValue - bValue : bValue - aValue;
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        window.toggleChart = (type) => {
            const wrapper = $(`${type}ChartWrapper`);
            if(wrapper.classList.contains('hidden')) {
                wrapper.classList.remove('hidden');
                if(type === 'sales') renderSalesChart();
                if(type === 'expenses') renderExpensesChart();
                if(type === 'profit') renderProfitChart();
                if(type === 'inventory') renderInventoryChart();
            } else {
                wrapper.classList.add('hidden');
            }
        };

        window.updateChartMode = (mode) => {
            currentChartMode = mode;
            const map = {daily:0, monthly:1, yearly:2};
            const btns = document.querySelectorAll('#salesChartWrapper button');
            btns.forEach((b,i) => {
                if(i===map[mode]) { b.className = "px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-600 font-bold hover:bg-blue-200 transition"; }
                else { b.className = "px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition"; }
            });
            renderSalesChart();
        };
        
        // Funciones Calculadora
        window.updateCalc = () => {
            const base = parseFloat($('calcBaseAmount').value) || 0;
            const pct = parseFloat($('calcPercentage').value) || 0;
            let result = 0;
            
            if (calcType === 'surcharge') {
                result = base * (1 + pct / 100);
            } else {
                result = base * (1 - pct / 100);
            }
            
            $('calcResultDisplay').textContent = fmtMoney(result);
            return result; // return for Apply
        };

        function updateClock() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if($('currentDateDisplay')) $('currentDateDisplay').textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
            if($('currentTimeDisplay')) $('currentTimeDisplay').textContent = now.toLocaleTimeString('es-ES');
        }
        setInterval(updateClock, 1000); updateClock();

        const initAuth = async () => {
            onAuthStateChanged(auth, user => {
                if(user) {
                    userId = user.uid;
                    $('connectionStatus').innerHTML = '<i class="fas fa-circle text-[8px] mr-1 text-green-500"></i> En L√≠nea';
                    $('authStatusText').textContent = "Conectado";
                    $('uidDisplay').textContent = user.isAnonymous ? `Anon: ${user.uid.substr(0,5)}` : user.email;
                    initListeners();
                    initializeNotifications();
                    listenToGlobalNotifications(); // Escuchar notificaciones globales
                    loadPinSettings(); // Cargar configuraci√≥n de PIN
                    
                    // Verificar y configurar FCM despu√©s de la autenticaci√≥n
                    setTimeout(() => {
                        checkAndSetupFCM();
                    }, 1000);
                } else {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                     else signInAnonymously(auth);
                }
            });
        };
        initAuth();

        function updateProductListForSale() {
            const select = $('saleProduct');
            if(!select) return;
            select.innerHTML = '<option value="" selected>Selecciona un producto del inventario (opcional)</option>';
            products.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                const currentStock = parseInt(p.stock) || 0;
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} (${p.prodType || 'Sin tipo'}) - Stock: ${currentStock}`;
                option.dataset.productType = p.prodType || '';
                option.dataset.productName = p.name || '';
                select.appendChild(option);
            });
            
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const productType = selectedOption.dataset.productType || '';
                const typeDisplay = $('selectedProductType');
                if (typeDisplay) {
                    typeDisplay.textContent = productType ? `Tipo: ${productType}` : '';
                }
            });
        }

        // ACTUALIZADO: Funci√≥n para actualizar filtro de canales
        function updateChannelFilter() {
            const channelSelect = $('filterSaleChannel');
            if (!channelSelect) return;
            
            // Limpiar opciones excepto la primera
            channelSelect.innerHTML = '<option value="all">Canal: Todos</option>';
            
            // Obtener canales √∫nicos de las ventas
            const channels = new Set();
            sales.forEach(s => {
                if (s.salesChannel && s.salesChannel.trim() !== '') {
                    channels.add(s.salesChannel);
                }
            });
            
            // A√±adir canales predeterminados si no existen
            const defaultChannels = ['Local F√≠sico', 'WhatsApp', 'Instagram', 'Sitio Web'];
            defaultChannels.forEach(channel => channels.add(channel));
            
            // Ordenar y a√±adir opciones
            Array.from(channels).sort().forEach(channel => {
                const option = document.createElement('option');
                option.value = channel;
                option.textContent = channel;
                channelSelect.appendChild(option);
            });
        }

        function initListeners() {
            const path = c => collection(db, 'artifacts', appId, 'users', userId, c);
            
            // Escuchar cambios en configuraciones
            onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'config'), (s) => {
                if(s.exists()) {
                    settings = { ...settings, ...s.data() };
                    if(!settings.blockedCategories) settings.blockedCategories = {};
                    $('storeNameDisplay').textContent = settings.storeName || "MI NEGOCIO";
                    renderEmployeeList();
                    updateDynamicLists(); 
                }
            });
            
            // Escuchar productos con IDs
            onSnapshot(path('products'), s => { 
                products = s.docs.map(d=>({id: d.id, ...d.data()})); 
                updateDashboard(); 
                renderInventory(); 
                updateProductListForSale();
            });
            
            // Escuchar ventas con IDs
            onSnapshot(path('sales'), s => { 
                sales = s.docs.map(d=>({id: d.id, ...d.data()})); 
                updateDashboard(); 
                renderSalesList(); 
                renderProfitReport();
                updateDynamicLists(); 
                updateChannelFilter(); // ACTUALIZADO: Actualizar filtro de canales
                
                // Enviar notificaci√≥n si hay nueva venta y notificaciones activadas
                if (s.docs.length > 0 && notificationPermission) {
                    const lastSale = s.docs[s.docs.length - 1].data();
                    if (lastSale.createdAt && new Date(lastSale.createdAt).getTime() > Date.now() - 5000) {
                        sendNotificationToAll('Nueva Venta Registrada', 
                            `${lastSale.employee || 'Empleado'} vendi√≥ ${fmtMoney(lastSale.montoCobrado || 0)} a ${lastSale.clientName || 'cliente'}`);
                    }
                }
            });
            
            // Escuchar gastos con IDs
            onSnapshot(path('expenses'), s => { 
                expenses = s.docs.map(d=>({id: d.id, ...d.data()})); 
                updateDashboard(); 
                renderExpensesList();
                renderProfitReport(); 
                updateDynamicLists(); 
                
                // Enviar notificaci√≥n si hay nuevo gasto
                if (s.docs.length > 0 && notificationPermission) {
                    const lastExpense = s.docs[s.docs.length - 1].data();
                    if (lastExpense.createdAt && new Date(lastExpense.createdAt).getTime() > Date.now() - 5000) {
                        sendNotificationToAll('Nuevo Gasto Registrado', 
                            `${lastExpense.manager || 'Encargado'} registr√≥ un gasto de ${fmtMoney(lastExpense.gastoTotal || 0)}`);
                    }
                }
            });
            
            // Escuchar clientes
            onSnapshot(path('clients'), s => { clients = s.docs.map(d=>({id: d.id, ...d.data()})); updateDashboard(); renderClientsTable(); }); 
            
            // Escuchar retiros con IDs
            onSnapshot(path('withdrawals'), s => { withdrawals = s.docs.map(d=>({id: d.id, ...d.data()})); updateDashboard(); renderCashMovements(); });
            
            // Escuchar ajustes con IDs
            onSnapshot(path('adjustments'), s => { adjustments = s.docs.map(d=>({id: d.id, ...d.data()})); updateDashboard(); renderCashMovements(); });
            
            // Escuchar notas diarias
            onSnapshot(path('dailyNotes'), s => { 
                news = s.docs.map(d => ({id: d.id, ...d.data()})); 
                renderNewsList(); 
                updateNewsBadge();
            });
            
            // Escuchar tokens FCM del usuario
            onSnapshot(path('fcm'), s => {
                const tokens = s.docs.map(d => ({id: d.id, ...d.data()}));
                console.log('Tokens FCM del usuario:', tokens);
            });
        }

        let detectedLists = {};
        function updateDynamicLists() {
            const payMethods = new Set(['Efectivo', 'Tarjeta Cr√©dito', 'Tarjeta D√©bito', 'Transferencia', 'QR', 'Nave']); 
            const channels = new Set(['Local F√≠sico', 'WhatsApp', 'Instagram', 'Sitio Web']);
            const prodTypes = new Set(['Importado', 'Nacional', 'Nuevo']);
            const cats = new Set(['Mercader√≠a', 'Servicios', 'Alquiler', 'Varios']);
            const managers = new Set(settings.employees || []);
            const expensePayments = new Set(['Efectivo', 'Transferencia', 'Tarjeta D√©bito', 'Tarjeta Cr√©dito', 'Otro']); 
            
            const isBlocked = (type, val) => (settings.blockedCategories[type] || []).includes(val);
            sales.forEach(s => {
                if(s.paymentType && !isBlocked('paymentType', s.paymentType)) payMethods.add(s.paymentType);
                if(s.salesChannel && !isBlocked('salesChannel', s.salesChannel)) channels.add(s.salesChannel);
            });
            expenses.forEach(e => {
                if(e.category && !isBlocked('category', e.category)) cats.add(e.category);
                if(e.manager && !isBlocked('manager', e.manager)) managers.add(e.manager);
                if(e.paymentMethod && !isBlocked('expensePaymentList', e.paymentMethod)) expensePayments.add(e.paymentMethod); 
            });
            products.forEach(p => { if(p.prodType && !isBlocked('prodType', p.prodType)) prodTypes.add(p.prodType); });
            
            detectedLists = { 
                paymentType: payMethods, 
                salesChannel: channels, 
                category: cats, 
                manager: managers, 
                prodType: prodTypes,
                expensePaymentList: expensePayments 
            };
            
            const fill = (id, set) => { $(id).innerHTML = ''; Array.from(set).sort().forEach(val => $(id).innerHTML += `<option value="${val}">`); };
            fill('paymentList', payMethods); fill('channelList', channels); 
            fill('categoryList', cats); fill('managerList', managers); fill('prodTypeList', prodTypes);
            fill('expensePaymentList', expensePayments); 
        }

        function openListManager(type) {
            const list = detectedLists[type] || new Set();
            const container = $('listManagerItems'); container.innerHTML = '';
            Array.from(list).sort().forEach(item => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-gray-50 p-2 rounded border";
                li.innerHTML = `<span>${item}</span>`;
                const btn = document.createElement('button');
                btn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                btn.className = "text-red-500 hover:text-red-700 px-2 cursor-pointer";
                btn.title = `Bloquear ${item}`;
                btn.onclick = async () => { 
                    try {
                        const newBlockedList = [...(settings.blockedCategories[type] || []), item];
                        const updatedBlocked = { ...settings.blockedCategories, [type]: newBlockedList };
                        await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'config'), { blockedCategories: updatedBlocked }, { merge: true });
                        li.remove();
                        showToast(`'${item}' bloqueado. Recarga para actualizar las listas.`, 'info');
                    } catch(e) { 
                        console.error("Error al bloquear la categor√≠a:", e); 
                        showToast("Error al bloquear la categor√≠a", 'error'); 
                    }
                };
                li.appendChild(btn); container.appendChild(li);
            });
            $('listManagerModal').classList.remove('hidden');
        }

        function detectShift(timeStr) {
            if(!timeStr) return '';
            const [h, m] = timeStr.split(':').map(Number);
            const floatTime = h + m/60;
            if (floatTime >= 10 && floatTime < 16) return 'Turno Ma√±ana';
            if (floatTime >= 16 && floatTime <= 21) return 'Turno Tarde';
            return 'Fuera de Horario';
        }

        function updateDashboard() {
            const today = getToday();
            const thisMonth = today.slice(0,7);
            
            let salesTotal = 0; 
            let expensesTotal = 0; 
            let sToday = 0; 
            let sMonth = 0; 
            
            let salesCashTotal = 0; 
            let expensesCashTotal = 0; 

            sales.forEach(s => { 
                const a = parseFloat(s.montoCobrado)||0; 
                sToday += (s.date === today) ? a : 0; 
                sMonth += (s.date.startsWith(thisMonth)) ? a : 0; 
                salesTotal += a; 
                
                if((s.paymentType||'').toLowerCase() === 'efectivo') {
                    salesCashTotal += a; 
                }
            });
            
            let eToday = 0, eMonth = 0;
            expenses.forEach(e => { 
                const a = parseFloat(e.gastoTotal)||0; 
                if(e.date===today) eToday+=a; 
                if(e.date.startsWith(thisMonth)) eMonth+=a; 
                expensesTotal += a;

                if((e.paymentMethod||'').toLowerCase() === 'efectivo') {
                    expensesCashTotal += a; 
                }
            });
            
            // MODIFICADO: Retiros de Romina NO se restan de la ganancia bruta
            const wTotal = withdrawals.reduce((a,w) => {
                const amount = parseFloat(w.amount)||0;
                // Si el empleado es Romina (CEO), no se resta de la ganancia bruta
                if (w.employee && w.employee.toLowerCase().includes('romina')) {
                    return a; // No sumar al total de retiros para la ganancia bruta
                }
                return a + amount;
            }, 0); 
            
            const adjTotal = adjustments.reduce((a,adj)=>a+(parseFloat(adj.amount)||0),0);

            const cashOnlyTotal = salesCashTotal - expensesCashTotal - wTotal + adjTotal; 
            const wTotalToday = withdrawals.filter(w => w.date === today).reduce((a,w)=>a+(parseFloat(w.amount)||0),0);

            $('dashVentasHoy').textContent = fmtMoney(sToday);
            $('dashGastosHoy').textContent = fmtMoney(eToday);
            $('dashTotalProductos').textContent = products.reduce((a,p)=>a+(parseInt(p.stock)||0),0);
            $('cardVentasHoy').textContent = fmtMoney(sToday);
            $('cardStockUnidades').textContent = products.reduce((a,p)=>a+(parseInt(p.stock)||0),0);
            $('dashTotalClientes').textContent = clients.length;
            
            $('cardVentasMes').textContent = fmtMoney(sMonth);
            $('cardGananciaMes').textContent = fmtMoney(sMonth - eMonth);
            
            $('cardCaja').textContent = fmtMoney(cashOnlyTotal); 
            $('cashModalGross').textContent = fmtMoney(salesTotal - expensesTotal);
            $('cashModalNet').textContent = fmtMoney(salesTotal - expensesTotal - wTotal);
            $('cashModalOnlyCash').textContent = fmtMoney(cashOnlyTotal); 
            $('cashModalWithdrawals').textContent = fmtMoney(wTotal);
            
            // Actualizar visibilidad de ganancia neta
            updateNetProfitVisibility();
        }

        const filterByDate = (item, dateField, fDate, fMonth, fYear) => {
            if(!item[dateField]) return false;
            const d = item[dateField];
            if(fDate && d !== fDate) return false;
            if(fDate) return true;
            const [y, mStr] = d.split('-');
            const m = parseInt(mStr) - 1;
            if(fMonth !== 'all' && m !== parseInt(fMonth)) return false;
            if(fYear !== 'all' && parseInt(y) !== parseInt(fYear)) return false;
            return true;
        };

        // --- FUNCIONES PARA EDITAR Y ELIMINAR ---

        async function deleteProduct(productId) {
            if (!confirm("¬øSeguro que quieres eliminar este producto? Esta acci√≥n no se puede deshacer.")) return;
            
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', productId));
                showToast("Producto eliminado correctamente", 'success');
                sendNotificationToAll('Producto Eliminado', 'Un producto ha sido eliminado del inventario');
            } catch (error) {
                console.error("Error eliminando producto:", error);
                showToast("Error al eliminar el producto", 'error');
            }
        }

        async function deleteSale(saleId) {
            if (!confirm("¬øSeguro que quieres eliminar esta venta? Esto tambi√©n revertir√° el stock.")) return;
            
            try {
                const saleDoc = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'sales', saleId));
                if (saleDoc.exists()) {
                    const saleData = saleDoc.data();
                    const productId = saleData.productId;
                    const quantitySold = parseInt(saleData.quantitySold) || 1;
                    
                    if (productId && quantitySold > 0) {
                        const productDoc = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', productId));
                        if (productDoc.exists()) {
                            const currentStock = parseInt(productDoc.data().stock) || 0;
                            const newStock = currentStock + quantitySold;
                            
                            await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', productId), {
                                stock: newStock.toString()
                            });
                        }
                    }
                }
                
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'sales', saleId));
                showToast("Venta eliminada y stock revertido", 'success');
                sendNotificationToAll('Venta Eliminada', 'Una venta ha sido eliminada del sistema');
            } catch (error) {
                console.error("Error eliminando venta:", error);
                showToast("Error al eliminar la venta", 'error');
            }
        }

        async function deleteExpense(expenseId) {
            if (!confirm("¬øSeguro que quieres eliminar este gasto?")) return;
            
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'expenses', expenseId));
                showToast("Gasto eliminado correctamente", 'success');
                sendNotificationToAll('Gasto Eliminado', 'Un gasto ha sido eliminado del sistema');
            } catch (error) {
                console.error("Error eliminando gasto:", error);
                showToast("Error al eliminar el gasto", 'error');
            }
        }

        async function deleteWithdrawal(withdrawalId) {
            if (!confirm("¬øSeguro que quieres eliminar este retiro?")) return;
            
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'withdrawals', withdrawalId));
                showToast("Retiro eliminado correctamente", 'success');
                sendNotificationToAll('Retiro Eliminado', 'Un retiro de caja ha sido eliminado');
            } catch (error) {
                console.error("Error eliminando retiro:", error);
                showToast("Error al eliminar el retiro", 'error');
            }
        }

        async function deleteAdjustment(adjustmentId) {
            if (!confirm("¬øSeguro que quieres eliminar este ajuste?")) return;
            
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'adjustments', adjustmentId));
                showToast("Ajuste eliminado correctamente", 'success');
                sendNotificationToAll('Ajuste Eliminado', 'Un ajuste de caja ha sido eliminado');
            } catch (error) {
                console.error("Error eliminando ajuste:", error);
                showToast("Error al eliminar el ajuste", 'error');
            }
        }

        async function deleteClient(clientId) {
            if (!confirm("¬øSeguro que quieres eliminar este cliente?")) return;
            
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'clients', clientId));
                showToast("Cliente eliminado correctamente", 'success');
                sendNotificationToAll('Cliente Eliminado', 'Un cliente ha sido eliminado de la base de datos');
            } catch (error) {
                console.error("Error eliminando cliente:", error);
                showToast("Error al eliminar el cliente", 'error');
            }
        }

        // Funci√≥n para editar producto
        function editProduct(product) {
            $('prodName').value = product.name || '';
            $('prodType').value = product.prodType || '';
            $('prodPrice').value = product.priceRetail || '';
            $('prodPriceUsd').value = product.priceUsd || '';
            $('prodStock').value = product.stock || '';
            
            const submitBtn = $('productForm').querySelector('button[type="submit"]');
            submitBtn.textContent = "Actualizar Producto";
            submitBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            submitBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            
            $('productForm').dataset.editingId = product.id;
            $('productModal').classList.remove('hidden');
        }

        // Funci√≥n para editar venta
        function editSale(sale) {
            $('saleDate').value = sale.date || getToday();
            $('saleTime').value = sale.time || new Date().toLocaleTimeString('es-ES', {hour12: false, hour: '2-digit', minute: '2-digit'});
            $('saleShift').value = sale.shift || detectShift($('saleTime').value);
            $('saleProduct').value = sale.productId || '';
            $('saleQuantity').value = sale.quantitySold || 1;
            $('saleAmount').value = sale.montoCobrado || '';
            $('saleEmployee').value = sale.employee || '';
            $('saleClient').value = sale.clientName || '';
            $('saleWhatsapp').value = sale.whatsapp || '';
            $('saleEmail').value = sale.email || '';
            $('salePayment').value = sale.paymentType || '';
            $('saleChannel').value = sale.salesChannel || '';
            $('saleNotes').value = sale.notes || '';
            
            const submitBtn = $('saleForm').querySelector('button[type="submit"]');
            submitBtn.textContent = "Actualizar Venta";
            submitBtn.classList.remove('bg-gray-900', 'hover:bg-gray-800');
            submitBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            
            $('saleForm').dataset.editingId = sale.id;
            $('saleForm').dataset.originalQuantity = sale.quantitySold || 1;
            $('saleForm').dataset.originalProductId = sale.productId || '';
            
            // Cambiar a modo unidad
            switchSaleType('single');
            $('newSaleModal').classList.remove('hidden');
        }

        // Funci√≥n para editar gasto
        function editExpense(expense) {
            $('expenseDate').value = expense.date || getToday();
            $('expenseAmount').value = expense.gastoTotal || '';
            $('expenseCategory').value = expense.category || '';
            $('expensePaymentMethod').value = expense.paymentMethod || '';
            $('expenseManager').value = expense.manager || '';
            $('expenseDesc').value = expense.description || '';
            
            const submitBtn = $('expenseForm').querySelector('button[type="submit"]');
            submitBtn.textContent = "Actualizar Gasto";
            submitBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            submitBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            
            $('expenseForm').dataset.editingId = expense.id;
            $('newExpenseModal').classList.remove('hidden');
        }

        function editClient(client) {
            $('newClientName').value = client.name || '';
            $('newClientWhatsapp').value = client.whatsapp || '';
            $('newClientEmail').value = client.email || '';
            
            const submitBtn = $('clientForm').querySelector('button[type="submit"]');
            submitBtn.textContent = "Actualizar Cliente";
            submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            submitBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            
            $('clientForm').dataset.editingId = client.id;
            $('newClientModal').classList.remove('hidden');
        }

        // Funci√≥n para editar retiro
        function editWithdrawal(withdrawal) {
            $('editWid').value = withdrawal.id;
            $('editWdDate').value = withdrawal.date || getToday();
            $('editWdAmount').value = withdrawal.amount || '';
            $('editWdEmployee').value = withdrawal.employee || '';
            $('editWdNote').value = withdrawal.note || '';
            
            $('editWithdrawalModal').classList.remove('hidden');
        }

        // Funci√≥n para editar ajuste
        function editAdjustment(adjustment) {
            $('editAdjId').value = adjustment.id;
            $('editAdjDate').value = adjustment.date || getToday();
            $('editAdjAmount').value = adjustment.amount || '';
            $('editAdjEmployee').value = adjustment.employee || '';
            $('editAdjNote').value = adjustment.note || '';
            
            $('editAdjustmentModal').classList.remove('hidden');
        }

        // --- CHARTS LOGIC ---

        function renderSalesChart() {
            const ctx = document.getElementById('salesChart');
            if(!ctx || $('salesChartWrapper').classList.contains('hidden')) return;
            if(salesChart) { salesChart.destroy(); salesChart = null; }

            const groupedData = {};
            currentFilteredSales.forEach(s => {
                const amount = parseFloat(s.montoCobrado) || 0;
                let key; const [y, m, d] = s.date.split('-');
                if (currentChartMode === 'daily') key = `${d}/${m}`;
                else if (currentChartMode === 'monthly') { const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"]; key = `${monthNames[parseInt(m)-1]} ${y}`; }
                else key = y;
                groupedData[key] = (groupedData[key] || 0) + amount;
            });
            
            const orderedKeys = Object.keys(groupedData).reverse();
            const dataPoints = orderedKeys.map(k => groupedData[k]);

            salesChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: orderedKeys, datasets: [{ label: 'Ventas ($)', data: dataPoints, backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgb(59, 130, 246)', borderWidth: 1, borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: {beginAtZero: true, grid:{display:false}}, x: {grid:{display:false}} } }
            });
        }
        
        function renderPaymentTypeChart() {
            const ctx = document.getElementById('paymentTypeChart');
            if(!ctx || $('paymentTypeChartWrapper').classList.contains('hidden')) return;
            if(paymentTypeChart) { paymentTypeChart.destroy(); paymentTypeChart = null; }

            const paymentCounts = {};
            currentFilteredSales.forEach(s => {
                const type = s.paymentType || 'Sin Pago';
                const amount = parseFloat(s.montoCobrado) || 0;
                paymentCounts[type] = (paymentCounts[type] || 0) + amount;
            });

            paymentTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: { 
                    labels: Object.keys(paymentCounts), 
                    datasets: [{ 
                        data: Object.values(paymentCounts), 
                        backgroundColor: ['#3b82f6', '#10b981', '#f97316', '#6366f1', '#ef4444', '#f59e0b'], 
                        borderWidth: 0 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: {position: 'right'},
                        tooltip: { callbacks: { label: (context) => {
                            let label = context.label || '';
                            if (label) label += ': ';
                            if (context.parsed) label += fmtMoney(context.parsed);
                            return label;
                        }}}
                    } 
                }
            });
        }
        
        function toggleSalesTimeChart() {
            const timeWrapper = $('salesChartWrapper');
            const paymentWrapper = $('paymentTypeChartWrapper');
            const toggleBtn = $('toggleSalesTimeChart');
            const otherBtn = $('togglePaymentTypeChart');
            
            if (timeWrapper.classList.contains('hidden')) {
                timeWrapper.classList.remove('hidden');
                paymentWrapper.classList.add('hidden');
                renderSalesChart();
                toggleBtn.classList.replace('text-gray-600', 'text-blue-600');
                toggleBtn.classList.replace('border-gray-200', 'border-blue-200');
                otherBtn.classList.replace('text-blue-600', 'text-gray-600');
                otherBtn.classList.replace('border-blue-200', 'border-gray-200');
            } else {
                timeWrapper.classList.add('hidden');
                toggleBtn.classList.replace('text-blue-600', 'text-gray-600');
                toggleBtn.classList.replace('border-blue-200', 'border-gray-200');
            }
        }

        function togglePaymentTypeChart() {
            const timeWrapper = $('salesChartWrapper');
            const paymentWrapper = $('paymentTypeChartWrapper');
            const toggleBtn = $('togglePaymentTypeChart');
            const otherBtn = $('toggleSalesTimeChart');

            if (paymentWrapper.classList.contains('hidden')) {
                paymentWrapper.classList.remove('hidden');
                timeWrapper.classList.add('hidden');
                renderPaymentTypeChart();
                toggleBtn.classList.replace('text-gray-600', 'text-blue-600');
                toggleBtn.classList.replace('border-gray-200', 'border-blue-200');
                otherBtn.classList.replace('text-blue-600', 'text-gray-600');
                otherBtn.classList.replace('border-blue-200', 'border-gray-200');
            } else {
                paymentWrapper.classList.add('hidden');
                toggleBtn.classList.replace('text-blue-600', 'text-gray-600');
                toggleBtn.classList.replace('border-blue-200', 'border-gray-200');
            }
        }

        function renderExpensesChart() {
            const ctx = document.getElementById('expensesChart');
            if(!ctx || $('expensesChartWrapper').classList.contains('hidden')) return;
            if(expensesChart) { expensesChart.destroy(); expensesChart = null; }

            const groupedData = {};
            const reversedList = [...currentFilteredExpenses].reverse();
            reversedList.forEach(e => {
                const amount = parseFloat(e.gastoTotal) || 0;
                let key; const [y, m, d] = e.date.split('-');
                key = `${d}/${m}`;
                groupedData[key] = (groupedData[key] || 0) + amount;
            });
            
            const labels = Object.keys(groupedData);
            const dataPoints = Object.values(groupedData);

            expensesChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Gastos ($)', data: dataPoints, backgroundColor: 'rgba(239, 68, 68, 0.5)', borderColor: 'rgb(239, 68, 68)', borderWidth: 1, borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: {beginAtZero: true, grid:{display:false}}, x: {grid:{display:false}} } }
            });
        }

        function renderProfitChart() {
            const ctx = document.getElementById('profitChart');
            if(!ctx || $('profitChartWrapper').classList.contains('hidden')) return;
            if(profitChart) { profitChart.destroy(); profitChart = null; }
            
            const salesMap = {};
            const expensesMap = {};
            const allDates = new Set();
            
            currentFilteredProfit.sales.forEach(s => { 
                const d = s.date; allDates.add(d); 
                salesMap[d] = (salesMap[d]||0) + (parseFloat(s.montoCobrado)||0); 
            });
            currentFilteredProfit.expenses.forEach(e => { 
                const d = e.date; allDates.add(d); 
                expensesMap[d] = (expensesMap[d]||0) + (parseFloat(e.gastoTotal)||0); 
            });

            const sortedDates = Array.from(allDates).sort();
            const labels = sortedDates.map(d => { const [y,m,day]=d.split('-'); return `${day}/${m}`; });
            const sData = sortedDates.map(d => salesMap[d]||0);
            const eData = sortedDates.map(d => expensesMap[d]||0);

            profitChart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: labels, 
                    datasets: [
                        { label: 'Ventas', data: sData, borderColor: 'rgb(34, 197, 94)', backgroundColor: 'rgba(34, 197, 94, 0.1)', fill: true, tension: 0.3 },
                        { label: 'Gastos', data: eData, borderColor: 'rgb(239, 68, 68)', backgroundColor: 'transparent', borderDash: [5, 5], tension: 0.3 }
                    ] 
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: {beginAtZero: true, grid:{display:false}}, x: {grid:{display:false}} } }
            });
        }

        function renderInventoryChart() {
            const ctx = document.getElementById('inventoryChart');
            if(!ctx || $('inventoryChartWrapper').classList.contains('hidden')) return;
            if(inventoryChart) { inventoryChart.destroy(); inventoryChart = null; }

            const typeCounts = {};
            currentFilteredInventory.forEach(p => {
                const t = p.prodType || 'Sin Tipo';
                typeCounts[t] = (typeCounts[t] || 0) + parseInt(p.stock||0);
            });

            inventoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: { 
                    labels: Object.keys(typeCounts), 
                    datasets: [{ 
                        data: Object.values(typeCounts), 
                        backgroundColor: ['#3b82f6', '#f97316', '#10b981', '#6366f1', '#8b5cf6'], 
                        borderWidth: 0 
                    }] 
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position: 'right'} } }
            });
        }

        // --- RENDER LISTS & LOGIC ---
        
        function renderCashMovements() {
            const tb = $('cashMovementsTableBody'); tb.innerHTML = '';
            const q = $('searchCashInput') ? $('searchCashInput').value.toLowerCase() : '';
            const fDate = $('filterCashDate') ? $('filterCashDate').value : '';
            const fMonth = $('filterCashMonth') ? $('filterCashMonth').value : 'all';
            const fYear = $('filterCashYear') ? $('filterCashYear').value : 'all';
            
            let filteredSalesCash = 0; 
            let filteredExpensesCash = 0; 

            sales.forEach(s => {
                if(filterByDate(s, 'date', fDate, fMonth, fYear) && (s.paymentType||'').toLowerCase() === 'efectivo') {
                    filteredSalesCash += parseFloat(s.montoCobrado)||0;
                }
            });

            expenses.forEach(e => {
                if(filterByDate(e, 'date', fDate, fMonth, fYear) && (e.paymentMethod||'').toLowerCase() === 'efectivo') {
                    filteredExpensesCash += parseFloat(e.gastoTotal)||0;
                }
            });

            const allMovements = [
                ...withdrawals.map(w => ({ ...w, type: 'Retiro', amount: -(parseFloat(w.amount)||0), note: w.note || '' })),
                ...adjustments.map(a => ({ ...a, type: 'Ajuste', amount: (parseFloat(a.amount)||0), employee: a.employee, note: a.note || '' }))
            ].filter(m => {
                if(q && !m.employee.toLowerCase().includes(q) && !m.note.toLowerCase().includes(q)) return false;
                return filterByDate(m, 'date', fDate, fMonth, fYear);
            }).sort((a,b)=>new Date(b.date + 'T' + (b.createdAt?.split('T')[1] || '00:00:00')).getTime() - new Date(a.date + 'T' + (a.createdAt?.split('T')[1] || '00:00:00')).getTime());

            let totalMovements = 0;
            allMovements.forEach(m => {
                totalMovements += m.amount;
                
                const isNegative = m.amount < 0;
                const sign = isNegative ? '-' : '+';
                const color = isNegative ? 'text-red-600' : 'text-green-600';
                const movementType = m.type === 'Retiro' ? 'Retiro Manual' : (m.amount > 0 ? 'Ajuste (Ingreso)' : 'Ajuste (Egreso)');
                
                tb.innerHTML += `<tr>
                    <td class="px-4 py-2 text-sm table-cell">${fmtDate(m.date)}</td>
                    <td class="px-4 py-2 text-sm font-bold table-cell">${movementType}</td>
                    <td class="px-4 py-2 text-sm text-gray-700 table-cell">${m.employee || 'N/A'} - <span class="text-gray-500 text-xs">${m.note}</span></td>
                    <td class="px-4 py-2 text-sm text-right font-bold ${color} table-cell">${sign}${fmtMoney(Math.abs(m.amount))}</td>
                    <td class="px-4 py-2 text-sm text-center table-cell">
                        <button onclick="edit${m.type === 'Retiro' ? 'Withdrawal' : 'Adjustment'}(${JSON.stringify(m).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 mx-1" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="delete${m.type === 'Retiro' ? 'Withdrawal' : 'Adjustment'}('${m.id}')" class="text-red-600 hover:text-red-800 mx-1" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            const cashFlowFiltered = filteredSalesCash - filteredExpensesCash;
            const totalCashFiltered = cashFlowFiltered + totalMovements; 

            $('cashModalOnlyCash').textContent = fmtMoney(totalCashFiltered);
            $('cashFilteredTotal').textContent = fmtMoney(totalCashFiltered); 
            
            const filteredWithdrawalsTotal = allMovements.filter(m => m.type === 'Retiro').reduce((sum, m) => sum + Math.abs(m.amount), 0);
            $('cashModalWithdrawals').textContent = fmtMoney(filteredWithdrawalsTotal);
        }

        function renderProfitReport() {
            const tb = $('profitTableBody'); tb.innerHTML = '';
            const fMonth = $('filterProfitMonth').value;
            const fYear = $('filterProfitYear').value;

            const filteredSales = sales.filter(i => filterByDate(i, 'date', null, fMonth, fYear));
            const filteredExpenses = expenses.filter(i => filterByDate(i, 'date', null, fMonth, fYear));
            
            currentFilteredProfit = { sales: filteredSales, expenses: filteredExpenses };

            const daily = {};
            const addToDay = (list, key, field) => {
                list.forEach(i => {
                    if(!daily[i.date]) daily[i.date] = { s:0, e:0 };
                    daily[i.date][key] += (parseFloat(i[field])||0);
                });
            };
            addToDay(filteredSales, 's', 'montoCobrado');
            addToDay(filteredExpenses, 'e', 'gastoTotal');

            const sorted = Object.keys(daily).sort((a,b)=>b.localeCompare(a));
            let tS = 0, tE = 0;
            sorted.forEach(d => {
                const day = daily[d];
                tS += day.s; tE += day.e;
                tb.innerHTML += `<tr>
                    <td class="table-cell font-bold">${fmtDate(d)}</td>
                    <td class="table-cell text-right text-green-600 font-medium">${fmtMoney(day.s)}</td>
                    <td class="table-cell text-right text-red-600">${fmtMoney(day.e)}</td>
                    <td class="table-cell text-right font-bold ${day.s-day.e>=0?'text-green-800':'text-red-600'}">${fmtMoney(day.s-day.e)}</td>
                    <td class="table-cell text-center">
                        <button onclick="deleteSale('${sales.find(s => s.date === d)?.id || ''}')" class="text-red-600 hover:text-red-800 mx-1" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            $('profitHeaderSummary').innerHTML = `<span class="text-green-700">Ganancia: ${fmtMoney(tS-tE)}</span> <span class="text-xs text-gray-500 font-normal ml-1">(V: ${fmtMoney(tS)} - G: ${fmtMoney(tE)})</span>`;

            if(!$('profitChartWrapper').classList.contains('hidden')) renderProfitChart();
        }

        // ACTUALIZADO: Funci√≥n renderSalesList con filtro de canal y nota
        function renderSalesList() {
            const tb = $('salesTableBody'); tb.innerHTML = '';
            const q = $('searchSaleInput').value.toLowerCase();
            const fDate = $('filterSaleDate').value;
            const fMonth = $('filterSaleMonth').value;
            const fYear = $('filterSaleYear').value;
            const fChannel = $('filterSaleChannel').value;
            
            const list = sales.filter(s => {
                if(q && !(s.clientName||'').toLowerCase().includes(q) && !(s.employee||'').toLowerCase().includes(q) && !(s.notes||'').toLowerCase().includes(q)) return false;
                if(fChannel !== 'all' && fChannel !== s.salesChannel) return false;
                return filterByDate(s, 'date', fDate, fMonth, fYear);
            }).sort((a,b)=> (b.date+b.time).localeCompare(a.date+a.time));
            
            currentFilteredSales = [...list]; 
            
            let total = 0;
            list.forEach(s => {
                total += parseFloat(s.montoCobrado)||0;
                const product = products.find(p => p.id === s.productId);
                const hasNote = s.notes && s.notes.trim() !== '';
                tb.innerHTML += `<tr>
                    <td class="table-cell"><div class="font-bold">${fmtDate(s.date)}</div><div class="text-xs text-gray-500">${s.time||''}</div></td>
                    <td class="table-cell font-bold">${s.clientName || 'Cliente no registrado'}</td>
                    <td class="table-cell text-sm">${product ? `${product.name} (${product.prodType || 'Sin tipo'})` : s.productName || '-'}</td>
                    <td class="table-cell text-center font-bold">${s.quantitySold||1}</td>
                    <td class="table-cell text-xs">${s.paymentType||'-'}</td>
                    <td class="table-cell text-xs">${s.employee||'-'}${hasNote ? '<br><span class="text-xs text-blue-600" title="' + s.notes + '"><i class="fas fa-sticky-note"></i></span>' : ''}</td>
                    <td class="table-cell text-right font-bold text-blue-600">${fmtMoney(s.montoCobrado)}</td>
                    <td class="table-cell text-center">
                        <button onclick="editSale(${JSON.stringify(s).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 mx-1" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteSale('${s.id}')" class="text-red-600 hover:text-red-800 mx-1" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            $('salesHistoryTotalLabel').textContent = `Total: ${fmtMoney(total)}`;

            if(!$('salesChartWrapper').classList.contains('hidden')) renderSalesChart();
            if(!$('paymentTypeChartWrapper').classList.contains('hidden')) renderPaymentTypeChart(); 
        }

        // ACTUALIZADO: Funci√≥n renderExpensesList con descripci√≥n visible
        function renderExpensesList() {
            const tb = $('expensesTableBody'); tb.innerHTML = '';
            const q = $('searchExpenseInput').value.toLowerCase();
            const fDate = $('filterExpenseDate').value;
            const fMonth = $('filterExpenseMonth').value;
            const fYear = $('filterExpenseYear').value;
            const list = expenses.filter(e => {
                if(q && !(e.category||'').toLowerCase().includes(q) && !(e.manager||'').toLowerCase().includes(q) && !(e.description||'').toLowerCase().includes(q)) return false;
                return filterByDate(e, 'date', fDate, fMonth, fYear);
            }).sort((a,b)=> b.date.localeCompare(a.date));
            
            currentFilteredExpenses = [...list];

            let total = 0;
            list.forEach(e => {
                total += parseFloat(e.gastoTotal)||0;
                const hasDesc = e.description && e.description.trim() !== '';
                tb.innerHTML += `<tr>
                    <td class="table-cell">${fmtDate(e.date)}</td>
                    <td class="table-cell font-bold">${e.category}</td>
                    <td class="table-cell text-xs">${e.paymentMethod||'-'}</td>
                    <td class="table-cell text-sm">${e.manager||'-'}</td>
                    <td class="table-cell text-right text-red-600">-${fmtMoney(e.gastoTotal)}${hasDesc ? '<br><span class="text-xs text-gray-500">' + e.description + '</span>' : ''}</td>
                    <td class="table-cell text-center">
                        <button onclick="editExpense(${JSON.stringify(e).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 mx-1" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteExpense('${e.id}')" class="text-red-600 hover:text-red-800 mx-1" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            $('expensesHistoryTotalLabel').textContent = `Total: ${fmtMoney(total)}`;

            if(!$('expensesChartWrapper').classList.contains('hidden')) renderExpensesChart();
        }

        function renderInventory() {
            const tb = $('inventoryTableBody'); tb.innerHTML = '';
            const q = $('searchInventoryInput').value.toLowerCase();
            const fDate = $('filterInvDate').value;
            const fMonth = $('filterInvMonth').value;
            const fYear = $('filterInvYear').value;
            const list = products.filter(p => {
                if(q && !p.name.toLowerCase().includes(q) && !(p.prodType||'').toLowerCase().includes(q)) return false;
                if(p.createdAt) {
                    const cDate = p.createdAt.split('T')[0];
                    return filterByDate({date: cDate}, 'date', fDate, fMonth, fYear);
                }
                return true;
            });
            
            currentFilteredInventory = [...list];

            list.forEach(p => {
                tb.innerHTML += `<tr>
                    <td class="table-cell font-medium">${p.name}</td>
                    <td class="table-cell text-xs">${p.prodType||''}</td>
                    <td class="table-cell text-right font-bold">${p.stock}</td>
                    <td class="table-cell text-right text-green-600">${fmtMoney(p.priceRetail)}</td>
                    <td class="table-cell text-right text-blue-600">${p.priceUsd ? 'US$'+p.priceUsd : '-'}</td>
                    <td class="table-cell text-center">
                        <button onclick="editProduct(${JSON.stringify(p).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 mx-1" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteProduct('${p.id}')" class="text-red-600 hover:text-red-800 mx-1" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            if(!$('inventoryChartWrapper').classList.contains('hidden')) renderInventoryChart();
        }

        function renderEmployeeStats() {
            const tb = $('employeeStatsTableBody'); tb.innerHTML = '';
            const fDate = $('filterStatsDate').value;
            const fMonth = $('filterStatsMonth').value;
            const fYear = $('filterStatsYear').value;
            
            const stats = {};
            let totalPeriodWithdrawals = 0;
            let totalPeriodCommission = 0; 

            const process = (list, field, isSale) => {
                list.forEach(i => {
                    if (!filterByDate(i, 'date', fDate, fMonth, fYear)) return;
                    const emp = i.employee; if(!emp) return;
                    if(!stats[emp]) stats[emp] = { shifts: new Set(), w:0, c:0 }; 
                    if(isSale) { 
                        stats[emp].shifts.add(`${i.date}_${i.shift||'D'}`);
                        const commission = parseFloat(i.commissionAmount)||0;
                        stats[emp].c += commission;
                        totalPeriodCommission += commission;
                    } 
                    else { 
                        const amount = parseFloat(i.amount)||0; 
                        stats[emp].w += amount; 
                        totalPeriodWithdrawals += amount; 
                    }
                });
            };
            process(sales, 'employee', true);
            process(withdrawals, 'employee', false);

            Object.keys(stats).forEach(e => {
                const s = stats[e];
                let h = 0; s.shifts.forEach(x => h += (x.includes('Ma√±ana')?6:(x.includes('Tarde')?5:1)));
                tb.innerHTML += `<tr>
                    <td class="table-cell font-bold">${e}</td>
                    <td class="table-cell text-center">${s.shifts.size}</td>
                    <td class="table-cell text-center">${h}h</td>
                    <td class="table-cell text-right text-green-600">${fmtMoney(s.c)}</td>
                    <td class="table-cell text-right text-red-600">${fmtMoney(s.w)}</td>
                    <td class="table-cell text-center">
                        <button onclick="alert('Acciones para ${e}')" class="text-blue-600 hover:text-blue-800 mx-1" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>`;
            });
            $('statsTotalCommission').textContent = fmtMoney(totalPeriodCommission);
            $('statsTotalWithdrawals').textContent = fmtMoney(totalPeriodWithdrawals);
        }
        
        function renderClientsTable() {
            const tb = $('clientsTableBody'); tb.innerHTML = '';
            const q = $('searchClientInput').value.toLowerCase();
            const fMonth = $('filterClientMonth').value;
            const fYear = $('filterClientYear').value;
            const list = clients.filter(c => {
                if(q && !c.name.toLowerCase().includes(q)) return false;
                if(c.createdAt) { const cDate = c.createdAt.split('T')[0]; return filterByDate({date: cDate}, 'date', null, fMonth, fYear); }
                return true;
            });
            list.forEach(c => {
                const spent = sales.filter(s => (s.clientName||'').toLowerCase()===c.name.toLowerCase()).reduce((a,b)=>a+(parseFloat(b.montoCobrado)||0),0);
                tb.innerHTML += `<tr>
                    <td class="table-cell font-bold">${c.name}</td>
                    <td class="table-cell text-xs">${c.whatsapp||'-'}</td>
                    <td class="table-cell text-xs">${c.email||'-'}</td>
                    <td class="table-cell text-right font-bold text-indigo-600">${fmtMoney(spent)}</td>
                    <td class="table-cell text-center">
                        <button onclick="editClient(${JSON.stringify(c).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 mx-1" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteClient('${c.id}')" class="text-red-600 hover:text-red-800 mx-1" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
        }
        
        function renderNewsList() {
            const c = $('newsListContainer'); c.innerHTML = '';
            if(news.length === 0) { c.innerHTML = '<div class="text-center text-gray-400 py-4">No hay novedades registradas.</div>'; return; }
            const sorted = [...news].sort((a,b) => (b.timestamp || b.date).localeCompare(a.timestamp || a.date));
            sorted.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-gray-50 p-4 rounded-xl border border-gray-100 flex justify-between items-start gap-3 hover:shadow-sm transition";
                let timeStr = ''; if(item.timestamp) { const d = new Date(item.timestamp); timeStr = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }
                div.innerHTML = `<div class="flex-1"><div class="text-xs text-gray-400 font-bold mb-1 flex items-center gap-2"><i class="far fa-clock"></i> ${fmtDate(item.date)} ${timeStr ? '- ' + timeStr : ''}</div><p class="text-gray-700 whitespace-pre-wrap text-sm">${item.text}</p></div>`;
                const btn = document.createElement('button'); btn.innerHTML = '<i class="fas fa-trash-alt"></i>'; btn.className = "text-red-300 hover:text-red-500 transition p-1"; btn.title = "Borrar nota";
                btn.onclick = async () => { 
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'dailyNotes', item.id)); 
                        showToast("Nota borrada", 'info');
                        sendNotificationToAll('Nota Eliminada', 'Una nota diaria ha sido eliminada');
                    } catch (e) {
                        console.error("Error deleting note:", e);
                        showToast("Error al borrar la nota", 'error');
                    }
                };
                div.appendChild(btn); c.appendChild(div);
            });
        }
        
        function updateNewsBadge() { 
            const today = getToday(); 
            const hasNewsToday = news.some(n => n.date === today); 
            const badge = $('newsBadge'); 
            if(hasNewsToday) badge.classList.add('active'); 
            else badge.classList.remove('active'); 
        }

        // L√ìGICA DE REGISTRO DE SERVICE WORKER Y ACTUALIZACIONES
        let deferredPrompt; 
        
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    console.log('Service Worker: Registro exitoso con el scope:', reg.scope);
                    notificationServiceWorker = reg;
                    
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    $('updateNotification').classList.remove('hidden');
                                }
                            }
                        });
                    });
                }).catch(error => {
                    console.error('Service Worker: Fallo en el registro:', error);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            registerServiceWorker();

            $('reloadUpdateBtn').onclick = () => {
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                }
                window.location.reload();
            };

            const installBtn = $('installAppBtn');
            window.addEventListener('beforeinstallprompt', (e) => { 
                e.preventDefault(); 
                deferredPrompt = e; 
                installBtn.classList.remove('hidden'); 
            }); 
            
            installBtn.onclick = async () => { 
                if (deferredPrompt) { 
                    deferredPrompt.prompt(); 
                    const { outcome } = await deferredPrompt.userChoice; 
                    if(outcome === 'accepted') console.log('PWA: Usuario acept√≥ la instalaci√≥n.');
                    else console.log('PWA: Usuario rechaz√≥ la instalaci√≥n.');

                    deferredPrompt = null; 
                    installBtn.classList.add('hidden'); 
                } 
            };

            $('openSideMenuBtn').onclick = () => { 
                $('sideMenu').classList.add('open'); 
                $('sideMenuOverlay').classList.remove('hidden'); 
            };
            
            const closeMenu = () => { 
                $('sideMenu').classList.remove('open'); 
                $('sideMenuOverlay').classList.add('hidden'); 
            };
            
            $('closeSideMenuBtn').onclick = closeMenu; 
            $('sideMenuOverlay').onclick = closeMenu;
            
            // Bot√≥n para abrir nivel 1 - modo joystick
            $('btnOpenLevel1').onclick = () => {
                $('level1Modal').classList.remove('hidden');
                // Inicializar juego despu√©s de que el modal est√© visible
                setTimeout(() => {
                    initGame();
                }, 100);
            };
            
            $('btnOpenPinConfig').onclick = () => {
                // Cargar configuraci√≥n actual en el modal
                if (pinSettings.pin) {
                    $('newPinInput').value = '';
                    $('newPinInput').placeholder = '**** (PIN actual establecido)';
                } else {
                    $('newPinInput').placeholder = '****';
                }
                
                // Marcar checkboxes seg√∫n configuraci√≥n
                $('protectSalesHistory').checked = pinSettings.protectedSections.salesHistory;
                $('protectProfit').checked = pinSettings.protectedSections.profitHistory;
                $('protectGrossProfit').checked = pinSettings.protectedSections.grossProfit;
                $('protectCashReal').checked = pinSettings.protectedSections.cashReal;
                $('protectSalesMonth').checked = pinSettings.protectedSections.salesMonth;
                $('protectNetProfit').checked = pinSettings.protectedSections.netProfit; // NUEVO
                
                $('pinConfigModal').classList.remove('hidden');
            };
            
            $('btnOpenDailyDetails').onclick = () => {
                $('dailyDetailsDate').value = getToday();
                loadDailyDetails();
                $('dailyDetailsModal').classList.remove('hidden');
            };
            
            $('btnNewSale').onclick = () => { 
                // Resetear formulario de unidad
                $('saleDate').value = getToday(); 
                $('saleTime').value = new Date().toLocaleTimeString('es-ES', {hour12: false, hour: '2-digit', minute: '2-digit'}); 
                $('saleShift').value = detectShift($('saleTime').value); 
                $('saleProduct').value = ""; 
                $('saleQuantity').value = 1; 
                $('saleAmount').value = ""; 
                $('saleEmployee').value = ""; 
                $('saleClient').value = ""; 
                $('salePayment').value = ""; 
                $('saleChannel').value = ""; 
                $('saleNotes').value = ""; 
                delete $('saleForm').dataset.editingId;
                delete $('saleForm').dataset.originalQuantity;
                delete $('saleForm').dataset.originalProductId;
                const submitBtn = $('saleForm').querySelector('button[type="submit"]');
                submitBtn.textContent = "Guardar Venta";
                submitBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                submitBtn.classList.add('bg-gray-900', 'hover:bg-gray-800');
                
                // Resetear formulario masivo
                massiveSaleRows = [];
                massiveSaleRowCounter = 0;
                $('massiveSaleDate').value = getToday();
                $('massiveSaleEmployee').value = "";
                const tbody = $('massiveSaleTableBody');
                tbody.innerHTML = '<tr id="massiveSaleEmptyRow" class="text-center text-gray-400 py-8"><td colspan="13" class="py-8"><div class="flex flex-col items-center justify-center gap-2"><i class="fas fa-layer-group text-3xl text-gray-300"></i><p>No hay filas agregadas. Haz clic en "Agregar Fila" para comenzar.</p></div></td></tr>';
                $('massiveSalesTotal').textContent = '$0.00';
                $('massiveSalesCount').textContent = '0';
                
                // Cambiar a modo unidad por defecto
                switchSaleType('single');
                $('newSaleModal').classList.remove('hidden'); 
            };
            
            $('btnNewExpense').onclick = () => { 
                $('expenseDate').value = getToday(); 
                delete $('expenseForm').dataset.editingId;
                const submitBtn = $('expenseForm').querySelector('button[type="submit"]');
                submitBtn.textContent = "Guardar Gasto";
                submitBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                submitBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                $('newExpenseModal').classList.remove('hidden'); 
            };
            
            $('btnNewProduct').onclick = () => { 
                delete $('productForm').dataset.editingId;
                const submitBtn = $('productForm').querySelector('button[type="submit"]');
                submitBtn.textContent = "Guardar";
                submitBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                submitBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                $('productModal').classList.remove('hidden'); 
            };
            
            $('openProfileModalBtn').onclick = () => $('profileModal').classList.remove('hidden');
            $('btnAddClientDirect').onclick = () => { 
                delete $('clientForm').dataset.editingId;
                const submitBtn = $('clientForm').querySelector('button[type="submit"]');
                submitBtn.textContent = "Guardar Cliente";
                submitBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                $('newClientModal').classList.remove('hidden'); 
            };
            
            document.querySelectorAll('[data-close]').forEach(b => b.onclick = () => $(b.dataset.close).classList.add('hidden'));
            
            $('btnOpenTutorialsModal').onclick = () => $('tutorialsModal').classList.remove('hidden');
            
            $('toggleSalesTimeChart').onclick = toggleSalesTimeChart;
            $('togglePaymentTypeChart').onclick = togglePaymentTypeChart;

            // Configurar bot√≥n de toggle de ganancia neta
            if ($('toggleNetProfitBtn')) {
                $('toggleNetProfitBtn').onclick = toggleNetProfitVisibility;
            }

            $('applyProfitFilterBtn').onclick = renderProfitReport;
            $('applySalesFilter').onclick = renderSalesList;
            $('resetSalesFilter').onclick = () => { 
                $('filterSaleDate').value=''; 
                $('filterSaleMonth').value='all'; 
                $('filterSaleYear').value='all'; 
                $('filterSaleChannel').value='all'; 
                $('searchSaleInput').value=''; 
                renderSalesList(); 
            };
            
            $('applyExpenseFilter').onclick = renderExpensesList;
            $('resetExpenseFilter').onclick = () => { 
                $('filterExpenseDate').value=''; 
                $('filterExpenseMonth').value='all'; 
                $('filterExpenseYear').value='all'; 
                $('searchExpenseInput').value=''; 
                renderExpensesList(); 
            };
            
            $('applyInvFilter').onclick = renderInventory;
            $('resetInvFilter').onclick = () => { 
                $('filterInvDate').value=''; 
                $('filterInvMonth').value='all'; 
                $('filterInvYear').value='all'; 
                $('searchInventoryInput').value=''; 
                renderInventory(); 
            };
            
            $('applyClientFilter').onclick = renderClientsTable;
            $('applyCashFilter').onclick = renderCashMovements;
            $('resetCashFilter').onclick = () => { 
                $('searchCashInput').value=''; 
                $('filterCashDate').value=''; 
                $('filterCashMonth').value='all'; 
                $('filterCashYear').value='all'; 
                renderCashMovements(); 
            };
            
            $('searchCashInput').oninput = renderCashMovements;

            $('btnOpenEmployeeStats').onclick = () => { 
                if($('filterStatsMonth').value === 'all' && $('filterStatsYear').value === 'all' && !$('filterStatsDate').value) { 
                    $('filterStatsMonth').value = new Date().getMonth().toString(); 
                    $('filterStatsYear').value = new Date().getFullYear().toString(); 
                } 
                renderEmployeeStats(); 
                $('employeeStatsModal').classList.remove('hidden'); 
            };
            
            $('applyStatsFilter').onclick = renderEmployeeStats;
            $('resetStatsFilter').onclick = () => { 
                $('filterStatsDate').value = ''; 
                $('filterStatsMonth').value = 'all'; 
                $('filterStatsYear').value = 'all'; 
                renderEmployeeStats(); 
            };

            // LISTENERS CALCULADORA
            $('openCalcBtn').onclick = () => {
                const currentVal = $('saleAmount').value;
                $('calcBaseAmount').value = currentVal;
                $('calcPercentage').value = '';
                $('calcResultDisplay').textContent = fmtMoney(parseFloat(currentVal) || 0);
                $('calculatorModal').classList.remove('hidden');
            };
            
            $('calcBaseAmount').oninput = updateCalc;
            
            $('calcTypeSurcharge').onclick = () => {
                calcType = 'surcharge';
                $('calcTypeSurcharge').className = "flex-1 py-2 rounded-lg border-2 border-transparent bg-blue-100 text-blue-700 font-bold text-sm hover:bg-blue-200 transition ring-2 ring-blue-500";
                $('calcTypeDiscount').className = "flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-100 text-gray-600 font-bold text-sm hover:bg-green-100 hover:text-green-700 transition";
                updateCalc();
            };
            
            $('calcTypeDiscount').onclick = () => {
                calcType = 'discount';
                $('calcTypeDiscount').className = "flex-1 py-2 rounded-lg border-2 border-transparent bg-green-100 text-green-700 font-bold text-sm hover:bg-green-200 transition ring-2 ring-green-500";
                $('calcTypeSurcharge').className = "flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-100 text-gray-600 font-bold text-sm hover:bg-blue-100 hover:text-blue-700 transition";
                updateCalc();
            };
            
            $('applyCalcResultBtn').onclick = () => {
                const res = updateCalc();
                $('saleAmount').value = res.toFixed(2);
                $('calculatorModal').classList.add('hidden');
                showToast("Resultado de calculadora aplicado.", 'info');
            };

            // BOT√ìN PARA TOGGLE NOTIFICACIONES
            $('notificationToggleBtn').onclick = toggleNotifications;

            // FORMULARIO DE VENTA MASIVA
            $('massiveSaleForm').onsubmit = async (e) => {
                e.preventDefault();
                if (!userId) return;

                const date = $('massiveSaleDate').value || getToday();
                const defaultEmployee = $('massiveSaleEmployee').value.trim();
                let savedCount = 0;
                let errorCount = 0;
                const errors = [];

                // Validar que haya al menos una fila
                if (massiveSaleRows.length === 0) {
                    showToast("Debe agregar al menos una fila para guardar.", 'error');
                    return;
                }

                // Procesar cada fila
                for (const rowId of massiveSaleRows) {
                    try {
                        const productSelect = document.querySelector(`#${rowId} .massive-product`);
                        const productId = productSelect ? productSelect.value : '';
                        const product = products.find(p => p.id === productId);
                        const quantityInput = document.querySelector(`#${rowId} .massive-quantity`);
                        const quantity = parseInt(quantityInput?.value) || 1;
                        
                        // Validar stock si hay producto seleccionado
                        if (productId && product) {
                            const currentStock = parseInt(product.stock) || 0;
                            if (quantity > currentStock) {
                                errors.push(`Fila ${rowId}: Stock insuficiente para "${product.name}". Solo quedan ${currentStock} unidades.`);
                                errorCount++;
                                continue;
                            }
                        }
                        
                        const amountInput = document.querySelector(`#${rowId} .massive-amount`);
                        const montoCobrado = parseFloat(amountInput?.value) || 0;
                        
                        if (montoCobrado <= 0) {
                            errors.push(`Fila ${rowId}: El monto debe ser mayor a 0.`);
                            errorCount++;
                            continue;
                        }
                        
                        const employeeInput = document.querySelector(`#${rowId} .massive-employee`);
                        const emp = employeeInput?.value.trim() || defaultEmployee || 'Sin encargado';
                        
                        const clientInput = document.querySelector(`#${rowId} .massive-client`);
                        const cName = clientInput?.value.trim() || 'Cliente no registrado';
                        
                        const paymentInput = document.querySelector(`#${rowId} .massive-payment`);
                        const paymentType = paymentInput?.value.trim() || 'Efectivo';
                        
                        const timeInput = document.querySelector(`#${rowId} .massive-time`);
                        const time = timeInput?.value || new Date().toLocaleTimeString('es-ES', {hour12: false, hour: '2-digit', minute: '2-digit'});
                        
                        const shiftInput = document.querySelector(`#${rowId} .massive-shift`);
                        const shift = shiftInput?.value || detectShift(time);
                        
                        const channelInput = document.querySelector(`#${rowId} .massive-channel`);
                        const salesChannel = channelInput?.value.trim() || '';
                        
                        const whatsappInput = document.querySelector(`#${rowId} .massive-whatsapp`);
                        const whatsapp = whatsappInput?.value.trim() || '';
                        
                        const emailInput = document.querySelector(`#${rowId} .massive-email`);
                        const email = emailInput?.value.trim() || '';
                        
                        const notesInput = document.querySelector(`#${rowId} .massive-notes`);
                        const notes = notesInput?.value.trim() || '';
                        
                        // Calcular comisiones para Yael
                        let commissionRate = 0;
                        let commissionAmount = 0;
                        
                        if (emp.toLowerCase() === 'yael') {
                            const normalizedPayment = paymentType.toLowerCase();
                            const lowCommissionPayments = ['qr', 'nave', 'tarjeta de debito', 'tarjeta de credito'];
                            
                            if (lowCommissionPayments.includes(normalizedPayment)) {
                                commissionRate = 0.03;
                            } else {
                                commissionRate = 0.07;
                            }
                            commissionAmount = montoCobrado * commissionRate;
                        }
                        
                        // Crear o actualizar empleado
                        if (emp && emp !== 'Sin encargado' && !settings.employees.includes(emp)) {
                            await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'config'), 
                                { employees: arrayUnion(emp) }, { merge: true });
                        }
                        
                        // Crear cliente si no existe
                        if (cName && cName !== 'Cliente no registrado' && !clients.some(c => c.name.toLowerCase() === cName.toLowerCase())) {
                            await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'clients'), {
                                name: cName,
                                whatsapp: whatsapp,
                                email: email,
                                createdAt: new Date().toISOString()
                            });
                        }
                        
                        // Actualizar stock si hay producto seleccionado
                        if (productId && product) {
                            const newStock = currentStock - quantity;
                            await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', productId), {
                                stock: newStock.toString(),
                                lastSale: new Date().toISOString()
                            });
                        }
                        
                        // Guardar la venta
                        const saleData = {
                            date: date,
                            time: time,
                            shift: shift,
                            montoCobrado: montoCobrado,
                            clientName: cName,
                            paymentType: paymentType,
                            salesChannel: salesChannel,
                            productName: product ? product.name : '',
                            productId: productId,
                            quantitySold: quantity,
                            employee: emp,
                            notes: notes,
                            commissionRate: commissionRate.toFixed(4),
                            commissionAmount: commissionAmount.toFixed(2),
                            whatsapp: whatsapp,
                            email: email,
                            createdAt: new Date().toISOString()
                        };
                        
                        await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'sales'), saleData);
                        savedCount++;
                        
                    } catch (error) {
                        console.error(`Error procesando fila ${rowId}:`, error);
                        errors.push(`Fila ${rowId}: Error interno del sistema.`);
                        errorCount++;
                    }
                }
                
                // Mostrar resultados
                if (savedCount > 0) {
                    if (errorCount > 0) {
                        showToast(`${savedCount} ventas guardadas. ${errorCount} con errores.`, 'warning');
                        if (errors.length > 0) {
                            console.error("Errores:", errors);
                        }
                    } else {
                        showToast(`${savedCount} ventas guardadas exitosamente.`, 'success');
                        sendNotificationToAll('Ventas Masivas Registradas', 
                            `Se registraron ${savedCount} ventas masivas. Total: ${$('massiveSalesTotal').textContent}`);
                    }
                    
                    // Cerrar modal y resetear
                    $('newSaleModal').classList.add('hidden');
                    massiveSaleRows = [];
                    massiveSaleRowCounter = 0;
                    const tbody = $('massiveSaleTableBody');
                    tbody.innerHTML = '<tr id="massiveSaleEmptyRow" class="text-center text-gray-400 py-8"><td colspan="13" class="py-8"><div class="flex flex-col items-center justify-center gap-2"><i class="fas fa-layer-group text-3xl text-gray-300"></i><p>No hay filas agregadas. Haz clic en "Agregar Fila" para comenzar.</p></div></td></tr>';
                    $('massiveSalesTotal').textContent = '$0.00';
                    $('massiveSalesCount').textContent = '0';
                    switchSaleType('single');
                    
                } else {
                    showToast("No se pudo guardar ninguna venta. Verifique los datos.", 'error');
                    if (errors.length > 0) {
                        alert("Errores encontrados:\n" + errors.join('\n'));
                    }
                }
            };

            // --- FUNCI√ìN PARA REGISTRAR VENTAS CON C√ÅLCULO DE COMISIONES DE YAEL ---
            $('saleForm').onsubmit = async(e) => { 
                e.preventDefault(); 
                if(!userId) return; 

                const isEditing = $('saleForm').dataset.editingId;
                const originalQuantity = parseInt($('saleForm').dataset.originalQuantity) || 0;
                const originalProductId = $('saleForm').dataset.originalProductId || '';
                
                const cName = $('saleClient').value.trim() || 'Cliente no registrado'; 
                const emp = $('saleEmployee').value.trim() || 'Sin encargado';
                const montoCobrado = parseFloat($('saleAmount').value) || 0;
                
                if (montoCobrado <= 0) {
                    showToast("El monto debe ser mayor a 0.", 'error');
                    return;
                }
                
                const productId = $('saleProduct').value.trim();
                const quantitySold = parseInt($('saleQuantity').value) || 1;
                const productToUpdate = products.find(p => p.id === productId);

                let stockUpdated = false;
                let originalProduct = null;
                
                // Manejo de stock solo si se seleccion√≥ un producto
                if (productId && productToUpdate) {
                    const currentStock = parseInt(productToUpdate.stock) || 0;
                    
                    // Si estamos editando
                    if (isEditing) {
                        // Revertir stock del producto original si cambi√≥ de producto
                        if (originalProductId && originalProductId !== productId) {
                            originalProduct = products.find(p => p.id === originalProductId);
                            if (originalProduct) {
                                const originalStock = parseInt(originalProduct.stock) || 0;
                                const newOriginalStock = originalStock + originalQuantity;
                                await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', originalProductId), {
                                    stock: newOriginalStock.toString()
                                });
                            }
                        } 
                        // Mismo producto, diferente cantidad
                        else if (originalProductId === productId && quantitySold !== originalQuantity) {
                            const stockDifference = originalQuantity - quantitySold;
                            const newStock = currentStock + stockDifference;
                            if (newStock < 0) {
                                showToast(`No hay suficiente stock. Stock actual: ${currentStock}`, 'error');
                                return;
                            }
                            await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', productId), {
                                stock: newStock.toString()
                            });
                            stockUpdated = true;
                        }
                    } 
                    // Nueva venta
                    else {
                        if (quantitySold > currentStock) {
                            showToast(`Stock insuficiente. Solo quedan ${currentStock} unidades.`, 'error');
                            return;
                        }
                        const newStock = currentStock - quantitySold;
                        await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', productId), {
                            stock: newStock.toString(), 
                            lastSale: new Date().toISOString()
                        });
                        stockUpdated = true;
                    }
                }

                // --- C√ÅLCULO DE COMISIONES DE YAEL (3% y 7%) ---
                const paymentType = $('salePayment').value.trim() || 'Efectivo';
                let commissionRate = 0;
                let commissionAmount = 0;

                // VERIFICAR: Si la empleada es Yael, aplica comisiones
                if (emp.toLowerCase() === 'yael') {
                    const normalizedPayment = paymentType.toLowerCase();
                    const lowCommissionPayments = ['qr', 'nave', 'tarjeta de debito', 'tarjeta de credito'];

                    if (lowCommissionPayments.includes(normalizedPayment)) {
                        commissionRate = 0.03; // 3% para QR, NAVE, Tarjetas
                    } else {
                        commissionRate = 0.07; // 7% para otros m√©todos
                    }
                    commissionAmount = montoCobrado * commissionRate;
                }
                // Para otros empleados, comisi√≥n = 0
                
                // Crear o actualizar empleado
                if(emp && emp !== 'Sin encargado' && !settings.employees.includes(emp)) {
                    await setDoc(doc(db,'artifacts',appId,'users',userId,'settings','config'), {employees:arrayUnion(emp)}, {merge:true}); 
                }
                
                // Crear cliente si no existe
                if(cName && cName !== 'Cliente no registrado' && !clients.some(c=>c.name.toLowerCase()===cName.toLowerCase())) {
                    await addDoc(collection(db,'artifacts',appId,'users',userId,'clients'), {
                        name: cName, 
                        whatsapp: $('saleWhatsapp').value || '', 
                        email: $('saleEmail').value || '', 
                        createdAt: new Date().toISOString() 
                    }); 
                }
                
                const saleData = { 
                    date: $('saleDate').value || getToday(), 
                    time: $('saleTime').value || new Date().toLocaleTimeString('es-ES', {hour12: false, hour: '2-digit', minute: '2-digit'}), 
                    shift: $('saleShift').value || detectShift($('saleTime').value), 
                    montoCobrado: montoCobrado, 
                    clientName: cName, 
                    paymentType: paymentType, 
                    salesChannel: $('saleChannel').value || '', 
                    productName: productToUpdate ? productToUpdate.name : '', 
                    productId: productId || '', 
                    quantitySold: quantitySold, 
                    employee: emp, 
                    notes: $('saleNotes').value || '', 
                    updatedAt: new Date().toISOString(),
                    commissionRate: commissionRate.toFixed(4), // Guarda la tasa de comisi√≥n
                    commissionAmount: commissionAmount.toFixed(2) // Guarda el monto de comisi√≥n
                };
                
                try {
                    if (isEditing) {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'sales', isEditing), saleData);
                        showToast("Venta actualizada con √©xito", 'success');
                        sendNotificationToAll('Venta Actualizada
